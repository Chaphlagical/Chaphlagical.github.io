---
title: 计算机系统的基本结构与工作原理
tags: 微机原理与嵌入式系统
article_header:
  type: cover
  image:
    src: /assets/images/embed.jpg

---

<!--more-->

## (一) 计算机系统的基本结构与组成

### 1、计算机的层次模型

* 分层的**目的**：分析计算机各个部件之间的逻辑关系

* 在计算机的发展过程中，出现过四种层次模型

	* **最初阶段**：只有两层

		* 硬件层：逻辑电路

		* 软件层：指令系统

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200220234812080.png" alt="image-20200220234812080" style="zoom: 50%;" />

	* **第二阶段**：微程序设计 vs RISC

		* 微程序设计思想—三层模型

			* 一条指令可以分解为多个微操作
			* 微操作可以用微指令实现
			* 多条微指令组成微程序实现指令功能
			* 微程序存储在ROM中，执行时逐条读出完成微操作

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200220234934058.png" alt="image-20200220234934058" style="zoom:50%;" />

		* **微程序**

			* 微程序简化了控制器硬件，并可实现复杂指令
			* 增加新指令，引入新的寻址方式，导致
				* 芯片中的器件数量增加
				* 芯片功耗不断增大
				* 而计算机性能与电路规模不成比例

		* RISC-Reduced Instruction Set Computing

			* **二八定律**
				* 80%的时间运行的是占总量不到20%的简单指令
				* 80%的任务是由占总量不到20%的电路完成的
			* John Cocke指出，为提高性能，应该：
				* 减少指令数量，一条复杂指令用多条简单指令替代
				* 取消微程序，指令功能由硬件电路（硬核）实现

### 2、操作系统

* 早期计算机没有操作系统，必须“手工”对计算机进行管理，如任务调度、内存管理、I/O控制等
* 第一个真正的操作系统：1964年可运行在不同规格的IBM System/360系列大型机的OS/360
* 操作系统负责管理计算机硬件资源和用户作业，提供了人机交互界面、多条用户命令和多种子程序调用接口，极大简化了计算机操作、管理的复杂性

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200220235755270.png" alt="image-20200220235755270" style="zoom:50%;" />

### 3、编程语言

* 使用各种语言编写的程序，必须经过相应的编译（或解释）程序进行处理后，计算机才能识别和执行

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200220235945622.png" alt="image-20200220235945622" style="zoom: 33%;" />

### 4、基于冯诺依曼架构的模型机系统

* **模型机结构特点**
	* 以CPU为核心（现代计算机逐步转化为以存储器为核心）
	* 单总线系统（类似于快慢车道不分的混合式交通）
	* 指令和数据使用同一条总线（冯诺依曼架构的主要缺陷）

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221000132043.png" alt="image-20200221000132043" style="zoom: 50%;" />

## (二) 模型机存储器子系统

### 1、存储器的组织和地址

* 每个字节拥有一个独一无二的物理地址（PA），字节是计算机可访问的最小存储单元

* 字节寻址存储器：按照字节组织存储器，连续地址对应于连续的字节单元

	* 例如：32位计算机中，一个字有4个字节，连续的字被分配到$n$，$n+4$，$n+8$……中

* 总线宽度为8位的计算机，CPU访问存储器时，总线一次可以传送一个字节数据

* 计算机的**分体结构**：

	* 对于32位计算机，总容量为$2^{32}$的存储器分成4个存储体，每个存储体为$2^{30}$，分别与32位数据总线如下图所示连接，每个存储体只需30条地址线，用字节选择信号进行选择

		<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221100215367.png" alt="image-20200221100215367" style="zoom:50%;" />

	* 示例：Intel 8086数据总线位宽为16位，地址总线位宽为20位

		* 总容量为1MB的存储系统分成2个512KB的存储体

		* 高位和低位字节存储体分别连接DB的高8位和低8位

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221100429277.png" alt="image-20200221100429277" style="zoom:33%;" />

			* $\overline{BHE}$和$A_0$为存储体选择信号
			* $\overline{BHE}$有效（低电平）选中高字节存储体；$A_0=0$选择低字节存储体；都有效同时选中两个存储体

### 2、字的对齐—对准存放

* 8位计算机没有对准存放问题
* **对准存放**：
	* 16位机的字起始地址应该是2的倍数，如0、2、4……
	* 32位机的字起始地址应该是4的倍数，如0、4、8……
	* 64位机的字起始地址应该是8的倍数，如0、8、16……

* 对准存放不是必须的，但如果采用对准存放，存取一个字只需要一次总线操作即可完成

### 3、小端格式和大端格式

* 假设$W$由$B_3$，$B_2$，$B_1$和$B_0$组成，$B_3$是最高字节，$B_0$是最低字节，存储$W$需使用4个地址连续的内存单元

* 对于地址依次为$m$、$m+1$、$m+2$和$m+3$的连续4个存储单元，$m$单元地址最小，称为尾部；$m+3$单元地址最大，称为头部

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221101015822.png" alt="image-20200221101015822" style="zoom:50%;" />

* $W$有两种存放格式

	* Intel x86采用小尾或小端格式

	* Motorola采用大尾或大端格式

		<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221101151184.png" alt="image-20200221101151184" style="zoom:50%;" />

* 如果采用对准存放，$m$是整个字的地址

### 4、存储器操作

* 两个最基本操作：读出和写入
* **读操作：**
	* 将一个指定存储单元的内容读出并传送到CPU中，读操作后存储单元的内容保持不变
	* 过程：CPU发送地址信号和读命令，被选中单元中的数据被读出到DB上，CPU采样数据并存入内部寄存器
* **写操作：**
	* CPU向指定单元传送数据，并覆盖目的单元原有内容
	* 过程：CPU通过AB、DB和CB分别发送地址、数据和写命令，DB上的数据被写入到被选中单元
* 连续数据读写：只需在第一次读写时发送地址

### 5、存储器的分级

* **对存储器的要求**：速度快、容量大、成本低

* **分级存储体系结构**：

	* 使用外村满足大容量、低成本和非易失的要求

	* 使用DRAM型内存，兼顾容量、速度和成本

	* 使用高速缓存，减少CPU访问内存的开销

		* 高速缓存：位于CPU与内存之间，SRAM型小容量快速存储器，用于存放CPU最近使用过或者可能要使用的指令和数据

		<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221101914371.png" alt="image-20200221101914371" style="zoom:50%;" />

## (三) 模型机CPU子系统

**模型机CPU内部结构**

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221102211604.png" alt="image-20200221102211604" style="zoom:80%;" />

### 1、运算器

* **基本组成**

	* 算术逻辑单元ALU
	* 累加器ACC
	* 标志寄存器FR
	* 暂存寄存器

* **逻辑运算单元ALU**：运算器的核心

	* 负责运算，也是数据传送的一条重要途径
	* 组成：带有先行进位功能的全加器（简称加法器）、移位寄存器以及相应的控制逻辑
	* 加法器是ALU最主要的部件，所有二进制算术运算都可通过加法和移位来实现

* **累加器ACC**：特殊寄存器

	* 提供需要送入ALU的操作数，存储ALU的计算结果
	* 早期的CPU只有一个ACC，因ACC与ALU之间密不可分，常被划分到运算器中，不属于通用寄存器组
	* 现代CPU中有很多通用寄存器都可以当作累加器来使用
	* ACC下方的累加锁存器：其作用是防止ALU的输出经ACC再反馈到ALU的输入端

* **暂存器**：

	* 暂时存放需要送入ALU的操作数，但不存放计算结果
	* 暂存器是透明度，程序员不可见

* **标志寄存器**：分为状态（条件码）位和控制位

	* **状态位**：记录ALU运算后的状态或者特征

		* 如：结果是否为零？是否为负数？是否有溢出？是否有进位？
		* 后续指令可根据状态标志决定程序执行顺序

	* 例如：

		* ARM处理器的程序状态寄存器（PSR）中有4个状态（条件码）

		* Intel 8086中还有辅助进位位A和奇偶校验位P（P现已不用）

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221110200766.png" alt="image-20200221110200766" style="zoom:33%;" />

	* **作用**：控制标志位，对CPU的某些行为进行控制和管理，例如：

		* Intel 8086的标志寄存器中有3个控制标志位
			* D(Direction)：串操作的地址改变方向
			* I(Interrupt)：是否允许外部中断
			* T(Trap)：单步中断
		* Intel 8086提供了对D和I进行单独操作的指令，如
			* STI：将I置位为1，允许外部可屏蔽中断，亦称开中断
			* CLI：将I复位为0，禁止外部可屏蔽中断，亦称关中断
		* Intel 8086还提供了对状态标志位C的3条操作指令，操作内容分别是置位、复位和取反

### 2、控制器

* 整个CPU的指挥控制中心

* 功能和作用：根据指令中的操作码和时序信号，产生各种控制信号，对系统各个部件的工作过程进行控制，指挥和协调整个计算机有序地工作

* **主要构成：**

	* 指令寄存器IR (Instruction Register)

	* 指令译码器ID (Instruction Decoder)

	* 操作控制器OC (Operation Controller)

	* 有观点认为包括程序计数器PC (Program Counter)

		（也有观点认为PC属于数据通道）

* **指令寄存器IR**

	* 临时存放从内存或者缓冲区中取出地下一条待执行指令，其输出作为指令译码器地输入

* **指令译码器ID**

	* 计算机能且只能执行“指令”
	* 指令由操作码和地址码两部分构成
		* 操作码表示要执行什么操作
		* 地址码表明指令执行时操作对象（操作数）的存放地址
	* 指令译码器只对操作码进行译码，分析和识别指令应该执行什么样的操作

* **操作控制器OC**

	* 根据指令译码器的译码结果，产生所需的各种控制信号并发送到相关部件，控制这些部件完成规定的操作
	* 操作控制器内部包括时序脉冲发生器、控制信号发生器、启停电路和复位逻辑等

* **程序计数器PC**

	* 存放下一条待执行指令在内存中的地址
	* 计算机开机时，指向引导程序的第一条指令
	* 顺序执行时，每条指令执行后自动修改，PC=PC+n，n与指令字长以及PC的单位有关
	* 遇到转移指令，转移目标地址→PC

* **微操作**

	* 每条指令的执行过程都可以分解为一系列的微操作

	* **微操作的特点**：可由简单电路实现；可被多个指令复用

	* 例如：

		* 假设指令“ADD R1，R2，R3”的功能为R2+R3→R1

		* 可以分解为以下八个微操作

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200221154750368.png" alt="image-20200221154750368" style="zoom:33%;" />

* 按实现方式分：微程序控制器和硬连线控制器

	**微控制器**

	* **简介**

		* 指令执行过程看作多个微操作序贯执行完成的
		* 对每个微操作进行编码，形成微操作码，微操作码可由简单电路产生微操作控制信号
		* 执行顺序控制位：指示后续微操作的执行顺序
		* 微操作码+执行顺序控制位=微指令
		* 指令→一段由若干微指令编排而成微程序
		* 所有指令对应的微程序都存放在控制存储器CM中逐条读出，其中微操作码经过译码产生微操作控制信号

	* **微程序控制器结构**

		* **微地址**：微指令在CM中的存放地址

		* **CLK**：作用等于读信号

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200222220538831.png" alt="image-20200222220538831" style="zoom:50%;" />

	* **工作原理和过程**

		* 计算机指令分为操作码和操作数地址两部分
		* 操作码由指令译码器译码，译码结果是该指令对应的微程序在CM中的首地址
		* 该地址经微地址译码器译码后，从CM中读出第一条微指令，其中微操作码部分送往微操作码译码器进行译码，生成相应的控制信号以实现规定的微操作
		* 执行顺序控制位送往微地址形成电路，生成下一条微指令的微地址
		* 不断重复上述过程，直到这段微程序全部执行完毕

	**硬连线控制器**

	* 也称为组合逻辑控制器，最早采用的控制器设计方法

	* 把控制器看作专门产生固定时序的控制信号的逻辑电路，以使用元件少和速度快作为设计目标

	* 因指令功能的多样性和差异性，导致所实现的控制器逻辑电路复杂、规模庞大，并且一旦形成就无法变更，除非重新设计和布线

	* **设计步骤**：

		* 输出：需要产生的微操作控制信号
		* 输入：微操作信号类型、执行条件和时序等
		* 列出逻辑表达式，经过化简，设计相应的逻辑电路

	* **一般结构**

		<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200222221618919.png" alt="image-20200222221618919" style="zoom:50%;" />

	* **特点**：速度快，电路复杂，不支持复杂指令，调试和改动困难，一度被微程序取代。今年因RISC的兴起和VLSI的进步，再度兴起

### 3、寄存器阵列

* 也称为寄存器组、寄存器堆和寄存器文件
* CPU内部若干高速存储单元，每个都有编号或名称，根据指令中的编号或者名称对其直接访问
* CPU与寄存器之间的数据交换是通过内部总线直接进行的，所以CPU与寄存器之间的数据传送速度最快
* 受指令长度限制，寄存器数量有限，只能暂时存放CPU工作时所需的少量数据和地址
* 分为专用寄存器和通用寄存器两大类
	* 专用寄存器作用固定，如PSR(FR)、IR和PC等
	* 通用寄存器：为ALU运算提供一个存储区，早期数量较少且通用性差，现在数量增加，通用性增强

### 4、地址与数据缓冲器

* CPU内部总线与系统总线之间的接口，提供地址和数据传送缓冲，同时增加CPU的系统总线驱动能力

### 5、数据通道

* 计算机各部件按功能划分为两大阵营：CU和EU
* CU为控制器，负责指令译码，生成相应的控制信号
* EU负责指令执行，如生成地址、读取和传送数据、计算和处理数据、存储结果、更新PSR和PC
* 在指令执行过程中，数据是在运算器、寄存器阵列和系统总线接口之间通过内部总线进行传送，所以这几个部件也被称为数据通道

## (四) 模型机指令集和指令执行过程

### 1、模型机指令集

* **指令**：分为微指令、机器指令和宏指令

	* 微指令：微程序级的命令
	* 机器指令：简称指令。CPU能识别和直接执行的一条二进制编码序列，包括操作码和操作数两部分
	* 宏指令：由若干条机器指令组成的软件指令

* **指令系统**：一台计算机中所有指令的集合

	* 指令集架构ISA：狭义上的计算机体系结构

* **汇编指令**

	* 助记符→操作码，标号和符号→指令和操作数地址

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200222234418591.png" alt="image-20200222234418591" style="zoom:50%;" />

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200222234459197.png" alt="image-20200222234459197" style="zoom:50%;" />

	* RISC指令风格：定长指令、Load/Store体系、三操作数
	* Rs-源操作数，Rd-目的操作数，Imm-立即数
	* Label-标号（用符号表示的指令地址）

* **定长指令**：每条指令长度固定

* **特点**：（假设32位机，32位指令长度）

	* 一次取指操作读取一个完整的指令
	* 受指令位数限制，对立即数的大小或者类型有要求
	* 同样原因，对内存寻址时，无法在指令中直接给出内存的单位地址
	* 内存单元地址可用如下方法表示：
		* 某个32位寄存器中的数值—寄存器间接寻址
		* 某个32位寄存器内容+偏移量—基址加偏移量寻址
		* 某两个寄存器之和—基址加索引寻址

### 2、指令周期

* **指令周期**：开始取值到完成指令操作的时间

	* 因功能和操作内容不同，许多处理器指令周期也不同

	* 有些采用流水线技术的RISC处理器，所有指令执行时间相同，被称为单周期处理器

* 一个指令周期分为若干个CPU周期（或称机器周期）

	* 一个CPU周期等于一次取指时间，也称为总线周期

* 一个总线周期包括若干个T周期，也称为时钟周期

	* T周期或时钟周期是处理器最基本的时间单位

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200222235513291.png" alt="image-20200222235513291" style="zoom:50%;" />

### 3、指令执行流程

* 示例：利用模型机汇编指令编程实现如下操作

	将数据000FF000h(0x000FF000)与内存中某个字数据相加，字数据的地址位于R3寄存器中，如果相加结果没有溢出，则将0x000FF000存入由R3+80h指定的内存单元，然后停机；如果溢出，直接停机

* 模型机汇编语言源程序片段：

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200225223527242.png" alt="image-20200225223527242" style="zoom:50%;" />

* 模型机系统结构：

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200225223636964.png" alt="image-20200225223636964" style="zoom: 67%;" />

* 用汇编语言编写的程序称为汇编语言源程序，简称汇编程序。将其转换成机器语言的过程称为汇编，能够实现汇编功能的软件称为汇编器或者汇编软件

* 汇编后的机器指令顺序存放，若指令长度为4字节，后一条指令地址等于前一条地址加4（PC的单位为字节）

* 上述模型机结构的**假设**：

	* 模型机是32位，数据总线32位，地址总线32位
	* RISC结构，定长指令设计，每条指令长度也是32位
	* 待运行程序的首地址为0x2000 0000
	* 第一条指令的机器码为“E3 A0 06 FF”

* **执行过程**：根据程序的名字，把0x20000000装入程序计数器PC，然后顺序执行如下操作：

	* PC内容0x20000000送至地址缓冲器/驱动器，地址总线的输出经地址译码器译码，寻址内存单元
	* PC值自动加4（假设PC内容的单元是字节），指向下一条指令的存放地址
	* OC发读信号，将“E3 A0 06 FF”读出到数据总线
	* 由于是取指操作，数据总线上的数据被装入IR
	* ID对操作码译码，OC产生相应的控制信号
	* 第一条指令源操作数是立即数（取指时能从指令编码中立即得到的数），被装入R0寄存器后指令执行完毕
	* 第二条：Load操作，从内存取操作数到R1，操作数地址由R3提供
	* 第三条：ADD运算，R0与R1相加，结果存入R1寄存器，完成运算后更新到FR中相关状态位
	* 第四条：条件转移，溢出则跳转执行标号为L2的指令，PC=PC+m（m是转移目的指令与转移指令之间的相对距离）；否则继续执行下一条指令
	* 第五条：Store操作，源操作数是R0寄存器的内容，目的操作数的地址是R3寄存器的内容再加上偏移量80h
	* 第六条：HTL停机，持续执行空操作

* **总结和讨论**

	* 指令执行时，指令操作码送到IR，经IR译码后OC产生操作控制信号
	* 指令的地址码送到地址形成部件，生成地址信号
	* CPU中的所有数据都在数据通道中传送
	* 指令执行过程属于多级串行作业，始终有一部分部件处于空闲状态，部件的利用率不高
	* 模型机属于冯诺依曼架构，串行工作方式的取指和存取操作数在时间上相互错开，不会出现冲突
	* 如果改用流水线方式，前后指令的取指和存取操作数可能同时发生。冯诺依曼体系结构将造成总线竞争，故不太适合流水线模式

## (五) 计算机体系结构的改进

### 1、CISC和RISC

#### (1) CISC

* 简介
	* 指令数量多，功能丰富，可实现复杂操作
	* 采用微程序控制器，为了减少硬件实现难度，减少硬件规模
	* 控制器结构简单、规整。增加新指令或者为已有指令添加新的功能较为容易→指令系统规模日渐庞大

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200225225746705.png" alt="image-20200225225746705" style="zoom:33%;" />

* **CISC处理器指令特点**

	* **指令长度不一**

		* 例如：
			* Intel 8086处理器的最短指令只有一个字节（如CLC），最长指令6字节。指令长度的变化范围为1~6字节
			* Motorola 68020处理器（32位）的指令长度从半个字到8个字，变化范围为2~32字节
		* 较长指令取指需要使用多个总线周期和多次总线操作
		* 长短不一的指令给指令译码器设计带来挑战，增加了控制器的复杂性和电路规模，也不利于采用流水线和超标量等新技术

	* **非Load/Store体系**

		* 算术和逻辑运算指令的操作数可以是存储数

			* 例如：存储器数+寄存器数→存储器
			* CISC仅需要一条指令：ADD[addr], Ri
			* RISC需要三条指令：LDR、ADD和STR，比CISC至少多出2次取值和译码操作

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200225231759411.png" alt="image-20200225231759411" style="zoom:50%;" />

	* **MOVE操作**

		* 格式为：Move destination，source的传送指令，可实现寄存器与存储器之间的数据传送
		* 大多数CISC处理器规定，MOVE指令的源操作数和目的操作数最多只能有一个是存储单元
		* 同一条总线上的两个存储单元，如果彼此之间需要传送数据，无论是RISC和CISC处理器，无论采用多条简单指令还是一条复杂指令，数据传送过程都分为两步
			* 第一步，将源操作数从内存单元中读出到某个通用寄存器暂存
			* 第二步，将暂存的内容写入目的存储单元

	* **两操作数**

		* 在现代CISC处理器中，大多数算术和逻辑运算指令只有两个操作数，其格式一般为：

			```
			OPR(操作码)	DST(目的操作数)	SRC(源操作数)
			```

		* 例如，加法指令：

			Add B，A

			对应的操作是(B)+(A)→B。指令执行后，结果送到B原来的存储位置，替换原先的内容。意味着DST既是目的操作数，也是参与运算的两个源操作数中之一

	* **指令功能强大、寻址方式多样、程序简洁**

		* CISC处理器的指令功能强大，可以实现复杂的操作，灵活多样的寻址方式有利于软件编程
		* 与RISC处理器相比，完成同样任务CISC处理器所需的指令数量较少，软件显得较为简洁
		* 指令数量少意味着所需的取指和译码操作次数也比较少，在不考虑其他技术因素（如流水线）的情况下，CISC处理器执行效率要高于RISC处理器

* **CISC处理器的性能问题**

	* **主要影响因素**：微程序控制器的工作流程
		* 完成一条指令需要从控制ROM中顺序读出多条微指令，需要多个在时间上序贯执行的微操作，这种在时间上串行作业模式将影响指令的执行速度
	* **两种解决思路**：
		* 提高处理器的工作时钟频率，加快微操作的节奏，但是增加时钟频率受到半导体材料物理特性的限制，并且难以消除由此产生的功耗和发热问题
		* 使用流水线和超标量等技术，让多条指令在时间上并行执行。但是由于CISC体系结构的特点，流水线和超标量的设计和实现遭遇很多困难

#### (2) RISC

* **特点**：
	* 摒弃微程序设计思想，采用硬连线方式实现控制器
	* 为了减少硬件实现难度，采用精简指令集
	* 减少处理器电路数，多余的芯片面积用于增加Cache容量以及寄存器数量，利用层次化的存储结构优化数据传送
	* 指令简单、长度一致、执行时间相同等特点使其更加易于引入流水线技术和超标量等可大幅度提高处理器性能的并行处理技术
	* CISC处理器一条复杂指令就能实现的操作，RISC处理器需要使用多条简单指令才能完成
	* 需要优秀的程序编译器，优化由数量较多的简单指令构成的程序代码
* **RISC指令特点**：
	* 寻址方式简单，种类较少
	* 指令集中的指令数量较少
	* Load/Store体系结构
	* 每条指令长度一致，执行时间相同
	* 面向寄存器的编程思想
	* 算术和逻辑运算指令普遍支持三操作数
	* 只能对寄存器操作数进行算术和逻辑运算
	* 程序代码量较大，因为执行复杂操作需要使用较多的简单指令

### 2、流水线技术

* **流水线技术**

	* 指令执行过程可分解为多个步骤，假设分解为:
		* fetch(取指)、Decode(译码)、Read(去操作数)、Execute(执行)和Writeback(回写)
	* 每个步骤都有专用部件完成操作，各部件分工明确，各司其职，每个步骤按照顺序执行
	* 模型机任何时候只能执行一条指令，前后指令呈多级串联作业模式，将会造成部件的“窝工”
	* 将功能部件按指令操作步骤顺序进行排列部署，前后部件之间增加缓冲寄存器，构成指令处理流水线
	* 前后两个部件经过缓冲寄存器隔离后，可以相对独立地并行工作
	* 部件之间地工作交接（数据传递）将通过缓存寄存器进行
	* 这种缓存寄存器被称为流水线寄存器

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226210758799.png" alt="image-20200226210758799" style="zoom: 50%;" />

	* 多条指令可以在流水线上以时间重叠的方式序贯执行

	<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226210853633.png" alt="image-20200226210853633" style="zoom:50%;" />

	* 在10个流水周期内
		* 串行作业模式只能完成2条指令的执行
		* 流水线方式至少可以完成5条指令的执行。多条指令以时间方式重叠方式执行使得IPC大大提高
	* 由于增加了流水线寄存器，增加了流水线寄存器写入时间和额外的门电路时延。因此，单条指令在流水线上执行所花费的时间要比非流水线方式更长
	* 流水线周期将受制于最慢的部件，将导致流水线的性能下降

* **流水线中的主要问题**

	* 流水线高效运行的前提：保持畅通，不发生断流

	* 指令执行过程中会出现以下三种相关冲突：

		* **资源相关**，也称为结构相关

			* 多条指令在同一周期内争用同一个公用部件
			* 例如：冯诺依曼结构计算机的Fetch、Load和Store操作都使用公用总线接口访问同一个存储器，前一条指令的数据存取操作可能会影响后续指令的取指操作
			* 解决方法
				* 后面一条指令等待一个节拍再启动。称为向流水线插入气泡或者插入阻塞，这将造成流水线性能下降
				* 采用哈佛结构（程序指令和数据分开的结构）。解除存取操作数与取指之间的资源相关

		* **数据相关**

			* 后一条指令执行需要使用前一条指令的结果。例如流水线上前后执行的两条运算逻辑令

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226213108260.png" alt="image-20200226213108260" style="zoom: 50%;" />

			*  SUB指令在第5个周期才将结果写回R1，但是AND指令在第4个周期就要读R1进行运算，而程序的本意是“写后读”（RAW）
			*  RAW是一种最为常见的数据相关
			*  流水线可能还存在“写后写”（WAW）和“读后写”（WAR）两类数据相关
				* WAW：$I_{j+1}$试图在指令$I_j$写数据之前写数据，这样最终结果将由$I_j$决定，而程序本意是保留$I_{j+1}$的结果
				* WAR：$I_{j+1}$试图在指令$I_j$读数据之前写数据，此时指令$I_j$读到的是被$I_{j+1}$篡改后的结果
				* 插入气泡可消除数据相关，但将造成流水线性能下降
			*  解决之道：
				* 定向推送，前一条指令执行结果通过专用通道直接推送给下一条，减少一个流水线周期，可减少数据相关
				* 优化编译器，对前后指令进行检查，调整执行顺序

		* **控制相关**

			* 遇到转移指令时，后续已进入流水线的指令都应清空
			* 以无条件转移（包括子程序调用）指令为例：
				* 假设指令$I_j$是无条件转移指令，其执行步骤为：取指、译码、计算转移地址并更新程序计算器PC。在第4个周期读取转移目标指令$I_k$。在此之前流水线上的指令$I_{j+1}$和$I_{j+2}$应清除，造成流水线断流。产生两个流水线周期延迟被称为转移代价

			<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226214414414.png" alt="image-20200226214414414" style="zoom:50%;" />

			* 减少转移代价的方法

				* 对于无条件转移指令，增加电路，在译码阶段提前计算转移目标地址，在第3个周期读取转移目标指令$I_k$，将转移代价减少到一个流水线周期

				<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226214718732.png" alt="image-20200226214718732" style="zoom:50%;" />

* **转移预测技术**

	* **转移延迟槽**：转移指令$I_j$后面的一个时间片。无论是否转移，位于转移延迟槽的指令总是会被执行。
	* **动态转移预测**：根据转移指令过去的行为进行预测
		* 动态“打分”：每发生一次转移，权值+1，加到11b为止；每发生一次不转移，-1，减到00b为止
		* 使用BTB（转移目标缓冲器），收集和存储了近期所有转移指令的有关信息，并按照查找表的形式进行组织
		* BTB不能太大，一般为1024个表项，其内容包括：
			* 转移指令$I_j$的地址（查找表索引）
			* $I_j$转移可能性的量化结果（2bit权值）
			* 转移目标指令$I_k$的地址
		* 每条指令在取指时，处理器根据其地址在BTB中进行快速搜索，若有记录则表明这是一条转移指令，并根据其“档案”进行相应处理，最后根据这条指令的实际行为修正BTB的记录内容

### 3、超标量机和多发射技术

* **标量处理器**：只能处理标量数据，一条指令一次只能处理一个数据，属于SSID
* **向量处理器**（阵列处理器），一条指令完成一个向量计算，属于SIMD，用于科学计算和信号处理等领域
* **超标量处理器**：拥有多条流水线，通过空间并行方式提高处理能力
	* 将多条指令分发到多条流水线上，同时执行
	* 分发前需配对检查，不同流水线上的指令不相干
	* 可以使用不同类型的流水线，如整数和浮点数
* **多发射技术**：多个指令分发单元

### 4、超线程处理器

* **进程**：程序的动态执行过程
	* 多任务系统中，CPU的运行时间被划分成多个时间片，CPU在不同的时间片轮流为每个任务进行服务
	* 早期，进程被作为作业调度和资源管理的基本单位
	* 进程运行时拥有所需的全部资源；任务切换时，操作系统回收资源并重新分配，无效开销太大
* **线程**：能独立执行的代码最基本单元
	* 每个进程拥有若干个线程
	* 线程是作业调度和执行的基本单元，拥有少量的必备资源，与进程中的其他线程共享全部资源
	* 线程调度时资源不可回收，无效开销小
* 单处理器同时只能执行一个线程，多线程只是利于操作系统的任务调度，减少无效开销，性能提高有限
* 超线程技术：为进一步减少处理器内部的硬件资源闲置，对流水线进行改造并添加少量部件，使处理器在同一时间可以执行两个线程
	* 超线程只是有了两个逻辑上的线程处理单元，每个线程并不是独自拥有所需的全部资源
	* ALU、FPU、Cach和总线接口等仍是两个线程共享
	* 超线程需要操作系统、应用软件以及主板BIOS的支持
	* 性能提升：多任务时可提升30%，单任务时处理器性能不升反降

### 5、多处理器计算机和多计算机系统

#### (1) 多处理器计算机

* 一个计算机有分布在不同的芯片上的多个处理器
* 多个处理器芯片通过共享内存或者共享总线进行数据交换，并行工作，属于一种紧耦合多处理器系统
* 多处理器计算机分为：
	* 非对称多处理器计算机AMP
		* 处理器有主从之分，不同的处理器承担不同的任务
	* 全对称多处理器计算机SMP
		* 现代服务器的主流架构。各处理器地位相同，对称工作；所有共享系统内存、I/O通道和外部设备

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226223649557.png" alt="image-20200226223649557" style="zoom:50%;" />

#### (2) 多计算机系统

* 多台计算机通过局域网以及私有网络彼此互连
* 每台计算机受各自独立的操作系统控制，有属于自己的存储系统和I/O设备，属于一种松耦合系统
* 可通过LAN或者SAN（存储域网）共享外部存储器，组成计算机集群
* 除提高了计算能力以外，也减少单点故障，具备高可用性，普遍应用于执行关键任务的信息系统中

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226224012666.png" alt="image-20200226224012666" style="zoom:50%;" />

##### (3) 分布式计算机系统

* 若干独立计算机或者集群通过网络互连而成
* 有一个全网统一的分布式操作系统，能够对用户所需的各种资源进行统一调度和管理，并且保证系统的一致性与透明性（不可见）
* 用户无需关心系统中的资源分布情况以及计算机差异
* 计算机之间没有主从之分，彼此既合作又自治，协同工作
* 分布式计算机系统是计算机应用领域发展的一个重要方向，也是云计算的主要基础

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226224419061.png" alt="image-20200226224419061" style="zoom:50%;" />

### 6、多核处理器

* 可集成的电路数越来越多，可以把多个功能完整的CPU集成在一个芯片上——单芯片多内核处理器

* 每个计算内核普遍采用超标量和超级流水线技术，拥有所需的全部计算资源，可彼此独立地执行任务

* 多个内核通过片内总线或交叉开关矩阵互连，可看作一个片上多处理器机CMP系统，对外呈现为一个统一的处理器

* 分为同构多核和异构多核两种类型

	* 同构—所有内核数相同，异构—根据需求选配不同的内核

* 多核处理器性能与任务的并行性有关

* **安达尔定律加速比**
	$$
	S=\frac{1}{1-a+\frac{a}{n}}
	$$
	其中，$n$为节点数，$a$为可并行代码比例

	* 若$a=0$，全是串行，$S=1$
	* 若$a=1$，全是并行，$S=n$
	* 若$20%$代码为串行，$a=0.8$，即使$n\rightarrow \infin,S\rightarrow 5$

* 应在核数、功耗、代价和实际效果间寻求平衡

## (六) Intel x86典型微处理器简介

### 1、Intel 8086处理器

* **简介**
	* 内部寄存器为16位，其中有4个可以分拆成8位使用
	* 16位数据总线，20位地址总线
	* 内存分段管理，段寄存器左移4位+偏移量=20位地址
	* I/O端口独立编址，端口总数为64K个
	* 时钟频率仅有5MHz，最高不超过10MHz
	* 分成指令执行单元EU和总线接口单元BIU两部分

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226234118820.png" alt="image-20200226234118820" style="zoom:50%;" />

### 2、Intel Pentium处理器

* **简介**
	* 与以往的80x86系列微处理器兼容
	* 32位地址总线，64位数据总线
	* 采用CISC结果实现超标量结构，两条并行的5级整数指令流水线（U和V），一条8级浮点运算流水线
	* 独立的指令Cache和数据Cache，数据和代码分离
	* 汲取RISC的优点，简单指令改用硬连线控制器实现
	* 基于BTB(转移目标地址缓冲器)的预测转移技术
	* 191条指令，支持9种寻址方式
	* 支持64位外部数据总线突发传输方式
	* 支持SMM模式，增强的错误检测和报告功能

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200226234729828.png" alt="image-20200226234729828" style="zoom: 50%;" />

## (七) ARM嵌入式处理器简介

### 1、ARM体系结构、ARM处理器和ARM内核

#### (1) ARM体系结构

* ARMv1~ARMv7属于32位架构，ARMv8属于64位架构

#### (2) ARM处理器和ARM内核

* 严格地说，ARM处理器是ARM公司设计的处理器
	* 内部仅有的最基本的数据处理核心，习惯上称之为内核
	* 基于同一体系结构版本，应用软件层面可相互兼容

### 2、ARM处理器的特点

* ARM处理器成功三要素
	* 代码密度高（代码占用内存少）
	* 功耗低
	* 性价比高
* 不同版本的ARM内核都具有**RISC架构**的共同特征：
	* 每条指令长度固定
	* 指令集中的指令数量较少
	* Load/Store体系结构
	* 只能对寄存器操作数进行算术和逻辑运算
	* 采用硬件布线逻辑，大部分指令在一个周期内完成执行
* ARM吸取的**CISC架构**特点：
	* 保留少数功能强大的复杂指令，如多寄存器传送指令
	* 提供自增、自减指令和基于PC的相对寻址方式
	* 用于转移指令和条件执行的条件码（N-负，Z-零，C-进位，V-溢出）
	* 少数指令可以在多个周期内完成
* **其他特点**
	* 支持不同的指令集
	* 指令的条件执行
	* 移位操作的实现方式

### 3、典型ARM内核基本结构

#### (1) ARM7TDMI，ARM7系列基本型产品

* 属于ARMv4T版本，产品后缀含义：
	* T表示支持16位的Thumb指令（ARM指令集的子集）
	* D表示支持片上Debug
	* M表示内嵌硬件乘法器
	* I表示内嵌ICE逻辑
* **内部结构**

<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200227005115430.png" alt="image-20200227005115430" style="zoom:50%;" />

* **简介**
	* ARM7家族其他产品的基础，内核中的内核
	* 包括一个32位ALU，一个32位桶形移位寄存器和一个32位x8位乘法器
	* 共有37个程序可访问的32位物理寄存器，包括31个通用寄存器和6个状态寄存器
		* 这些资源不是同时可见，在不同工作状态以及不同工作模式下只能看到其中一部分
		* 在任何状态和模式下，最多只能看到其中的18个
	* “写”和“读”数据总线分开，片外只需配置单向总线驱动器，没有双向驱动器的方向转换时延
* **特点**
	* 有ARM和Thumb两种状态，可软件切换，分别支持全功能的32位ARM指令集和简洁的16位Thumb指令集
	* 一条3级（取指、译码和执行）流水线，性能可达0.9MIPS/MHz；支持8bit、16bit和32bit数据操作
	* 快速中断响应能力
	* 写数据和读数据总线分开，片外无需双向驱动器
	* 冯诺依曼结构，系统简洁，门电路数量较少
	* 高性能、低成本，超低功耗，尤其适合对功耗有苛刻要求的场合，如依赖电池供电的各种手持式电子设备

#### (2) ARM9系列产品简介

* ARM9产品家族可分为ARM9和ARM9E两个系列

	* ARM9系列是基于ARMv4T版本的普通型产品，包括ARM9TDMI、ARM920T、ARM922T和ARM940T
	* ARM9E系列则是基于ARMv5TE版本的增强型产品，具有DSP和Java扩展功能，包括ARM926EJ和ARM946E

* ARM9系列与ARM7相比在体系结构上的改进

	* 指令流水线升级为5级（取指、译码、执行、存储器访问和回写），每级电路更简单，执行速度更快
	* 采用哈佛结构，减少发生资源冲突的概率
	* Thumb指令采用硬件译码，速度高于软件译码的ARM7

* ARM9TDMI

	* ARM9TDMI是ARM9产品家族中的基本型产品
	* 同系列的其他处理器都是以ARM9TDMI为核心，扩展和集成其他功能部件所构成：
		* 指令Cache和数据Cache、AMBA总线接口、嵌入式跟踪宏单元ETM、MMU或者MPU等

* ARM920T

	* **简介**

		* 属于ARM9系列，以ARM9TDMI为核心，另外配置了
			* 各16B的数据和指令cache
			* 数据和指令MMU
			* 写缓存（16字的数据，4个地址）
			* CP15
			* 外部协处理器接口
			* 嵌入式跟踪宏单元ETM
		* 支持VxWorks，WindowsCE和Linux等嵌入式OS
		* 高性价比和低功耗，典型的目标SOC芯片

	* **结构**

		<img src="/assets/images//计算机系统的基本结构与工作原理.assets/image-20200227084700807.png" alt="image-20200227084700807" style="zoom:50%;" />

		* 两类地址信号：物理地址PA和虚拟地址VA
			* Physical Address：每个存储单元所拥有的真实地址
			* Virtual Address：编程时所使用的地址，也称为逻辑地址
			* 由MMU负责PA和VA的映射和转换
		* CP15：系统控制协处理器，用于管理和控制Cache、MMU、时钟类型和大小端设定等系统级操作
		* 回写物理地址TAG：地址标记寄存器，存放Cache中需要回写（更新）数据字段在主存中的地址信息
		* 数据总线上的写缓存：提高数据回写操作的速度
		* JTAG：符合JTAG规范的测试接口

## (八) 计算机性能测评

### 1、定性描述指标

* 机器字长
* 存储容量，主要是cache大小和内存容量
* 总线带宽和数据吞吐速率，主要取决于采用总线标准
* 能耗与环保
* RASIS特性：
	* Reliability，可靠性，MTTF与MBTF
	* Availability，可用性，系统正常运行时间的百分比
	* Serviceability，可维护性
	* Integrity，集成性，all in one
	* Security，安全性

### 2、定量描述指标

速度，如各种“跑分”

### 3、早期指标

MIPS，对CISC和RISC不能客观评价

### 4、现在指标

基准测试结果，如：

* Whetstone和Dhrystone：前者包括浮点数，后者只有整数，使用FORTRAN编写，代码量太小，与编译器有关
* CoreMark：2009年由EEMBC提出，用C语言编写，包含嵌入式系统常见的4种计算（矩阵、查找和排序、状态机和CRC），已成为嵌入式内核标准评测的事实标准
* **SPEC测试**，通用计算机使用最多的基准测试
	* SPECjbb，用于评测JAVA应用服务器的性能
	* SPECint，用于评测整数计算及编译器优化能力
	* SPECfp，用于评测浮点数计算及编译器优化能力
	* SPEC CPU，用于评测单核或多核处理器在进行整数及浮点数计算时的性能，包括多个种类和多个测试项目

### 5、其他基准测试

* **TPC**，主要针对计算机在数据库应用及事务处理方面的性能，常见的有

	* TPC-C，反映OLTP（联机事务处理）性能
	* TPC-H，反映OLAP（联机事务分析）性能

* TPC是大型信息系统核心主机选型的重要依据

* **Linpack**（线性系统软件包）

	一种高性能计算机系统浮点性能测试基准。通过在计算机（集群）系统中运行Linpack测试程序，可以得到能够反映高性能计算机浮点性能的测试结果Flops。在高性能计算领域，Linpack指标收到普遍重视

* **SAP基准测试**。SAP研发ERP在大型企业中得到广泛的应用，其测试结果对于ERP系统的硬件选型和配置具有一定指导意义