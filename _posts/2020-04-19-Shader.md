---
layout: post
title: Shader
subtitle: USTC CG Course 2020
thumbnail-img: /assets/images/thumbnail-img/shader.png
cover-img: /assets/images/cover-img/CG.png
comments: true
gh-repo: Chaphlagical/USTC_CG
gh-badge: [star, fork, follow]
tags: [CG, OpenGL, Render]
readtime: true
---

Some useful and basic OpenGL shader.

## Feature

* Normal Map
* Displacement Map
* Using Displacement Map to Denoise
* Point Light Shadow

## Development Environment

* **IDE**: Microsoft Visual Studio 2019 community
* **Build**: CMake 3.16.3
* **other 3rd Party Library**: Assimp 5.0.1, glfw 3.4.0

## Algorithm Introduction

### Normal Map

A typical usage is as follows:

![normal_map_usage](https://chaphlagical.github.io/assets/images/assets-img/Shader/normal_map_usage.jpg){: .mx-auto.d-block :}

Since the normal direction in the texture map is defined in the tangent space, the up direction is the z direction, which corresponds to the B channel of RGB. Therefore, the normal map is generally blue-violet. By changing the normal vector according to the details of the surface, you can get an illusion that looks much more complicated on the surface:

![normal_mapping_surfaces](https://chaphlagical.github.io/assets/images/assets-img/Shader/normal_mapping_surfaces.png){: .mx-auto.d-block :}

### Displacement Map

A typical usage is as follows:

![displacement_map_usage](https://chaphlagical.github.io/assets/images/assets-img/Shader/displacement_map_usage.jpg){: .mx-auto.d-block :}

In the displacement map, black (0) means not moving, and white (1) means moving in the normal direction. The relationship between the pixel value of the displacement map and the offset can be defined:

$$
displacement=lambda*(bias+scale*pixel value)
$$

* $bias=-1$, $scale=2$: $0\sim 0.5$  will be sag, $0.5\sim1.0$ will be raised, the variation is determined by a coeffcient.
* $bias=0$, $scale=1$: $0\sim1.0$ will be raised, the variation is determined by a coeffcient.

In real-time rendering, the displacement map is sampled in the vertex shader, the vertex offset is calculated to move the vertex, and the corresponding normal map is added to make sure that the rendering effect is correct.

**Displacement Map for Denoise**

1. Calculate the offset of each vertex

$$
\delta_i=p_i-\frac{1}{|N(i)|}\sum\limits_{j\in N(i)}p_j
$$

2. Project the offset to the normal direction

$$
\bar{\delta}_i=\langle\delta_i,\pmb{n}_i\rangle \pmb{n}_i
$$

3. Moving each vertex

$$
 \bar{p}_i=p_i-\lambda \bar{\delta}_i=p_i-\lambda\langle\delta_i,\pmb{n}_i\rangle \pmb{n}_i
$$

4. Interpolate $\langle\delta_i,\pmb{n}_i\rangle$ and save it into a displacement map

### Point Light Shadow

**Render depth map from light source**

![render_from_light](https://chaphlagical.github.io/assets/images/assets-img/Shader/render_from_light.png){: .mx-auto.d-block :}

**Render image from camera**

![render_from_camera](https://chaphlagical.github.io/assets/images/assets-img/Shader/render_from_camera.png){: .mx-auto.d-block :}

## Demo

### Normal Map

![normal_map](https://chaphlagical.github.io/assets/images/assets-img/Shader/normal_map.png){: .mx-auto.d-block :}

### Displacement Map

![displacement_map](https://chaphlagical.github.io/assets/images/assets-img/Shader/displacement_map.png){: .mx-auto.d-block :}

![poem_map](https://chaphlagical.github.io/assets/images/assets-img/Shader/poem_map.png){: .mx-auto.d-block :}

![code_map](https://chaphlagical.github.io/assets/images/assets-img/Shader/code_map.png){: .mx-auto.d-block :}

![USTC_map](https://chaphlagical.github.io/assets/images/assets-img/Shader/USTC_map.png){: .mx-auto.d-block :}

### Denoise

**Before**

![noise](https://chaphlagical.github.io/assets/images/assets-img/Shader/noise.png){: .mx-auto.d-block :}

**After**

![fix](https://chaphlagical.github.io/assets/images/assets-img/Shader/fix.png){: .mx-auto.d-block :}

### Demo Video

<video width="100%" height="100%" id="video" controls="" preload="none" poster="">
      <source id="mp4" src="https://chaphlagical.github.io/assets/videos/Shader/demo1.mp4" type="video/mp4">
      </video>

<video width="100%" height="100%" id="video" controls="" preload="none" poster="">
      <source id="mp4" src="https://chaphlagical.github.io/assets/videos/Shader/demo2.mp4" type="video/mp4">
      </video>

## Resource

**Project**: [https://github.com/Chaphlagical/USTC_CG/tree/master/Homeworks/8_Shader](https://github.com/Chaphlagical/USTC_CG/tree/master/Homeworks/8_Shader) 