---
title: PBR实时渲染基础
tags: 计算机图形学
article_header:
  type: cover
  image:
    src: /assets/images/cg.jpg

---

<!--more-->

## 1. PBR光照模型基于物理的条件

### 1.1. 基于微平面的表面模型

微平面理论认为，达到微观尺度后任何平面都可以用被称为微平面的细小镜面来描绘，根据平面粗糙程度不同，这些细小镜面的取向排列可以不一致：

![img](https://learnopengl-cn.github.io/img/07/01/microfacets.png)

一个平面越是粗糙，这个平面上的微平面的排列就越混乱

![img](https://learnopengl-cn.github.io/img/07/01/microfacets_light_rays.png)

在微观尺度下没有完全光滑的平面，需要我们假设一个粗糙度参数来刻画微平面的粗糙程度。基于一个平面的粗糙度来计算出某个向量的方向与微平面平均取向方向一致的概率：
$$
h=\dfrac{l+v}{\|l+v\|}
$$
其中$l$为光线向量，$v$为视线向量

微平面的取向方向与中间向量的方向越是一致，镜面反射的效果就越是强烈越是锐利。然后再加上一个介于0到1之间的粗糙度参数，即可估算微平面的取向情况：

![img](https://learnopengl-cn.github.io/img/07/01/ndf.png)

### 1.2. 能量守恒

微平面近似法的能量守恒：出射光线的能量永远不能超过入射光线的能量（发光面除外）

![img](https://learnopengl-cn.github.io/img/07/01/surface_reaction.png)

一般来说，并非所有能量都会被全部吸收，而光线也会继续沿着（基本上）随机的方向发散，然后再和其他的粒子碰撞直至能量完全耗尽或者再次离开这个表面。而光线脱离物体表面后将会协同构成该表面的（漫反射）颜色

对于金属表面，金属表面对光的反应与非金属材料表面不同，它们遵循相同的折射反射定律，但对于金属表面，所有的折射光都会被直接吸收而不会散开，只留下反射光

#### 1.2.1. 反射率方程

渲染方程特化版——反射率方程：
$$
L_o(p,\omega_o)=\int_\Omega f_r(p,\omega_i,\omega_o)L_i(p,\omega_i)n\cdot \omega_i\mathrm d\omega_i
$$
**辐射通量：**辐射通量$\Phi$表示的是一个光源所输出的能量，以瓦特为单位。光是由多种不同波长的能量所集合而成的，而每种波长则与一种特定的（可见的）颜色相关

**立体角：** 立体角用$\omega$表示，它可以为我们描述投射到单位球体上的一个截面的大小或者面积。投射到这个单位球体上的截面的面积就被称为立体角

![img](https://learnopengl-cn.github.io/img/07/01/solid_angle.png)

**辐射强度：** 辐射强度表示的是在单位球面上，一个光源向每单位立体角所投送的辐射通量

![img](https://learnopengl-cn.github.io/img/07/01/radiant_intensity.png)

计算辐射强度的公式如下：
$$
I=\dfrac{\mathrm d\Phi}{\mathrm d\omega}
$$
其中$I$表示辐射通量$\Phi$除以立体角$\omega$
一个拥有辐射强度$\Phi$的光源在单位面积$A$，单位立体角$\omega$上的辐射出的总能量：
$$
L=\dfrac{\mathrm d^2\Phi}{\mathrm dA\mathrm d\omega\cos\theta}
$$

### 1.3. 应用基于物理的BRDF

双向反射分布函数BRDF接受入射光方向$\omega_i$，出射光方向$\omega_o$，平面法线$n$以及一个用来表示微平面粗糙程度的参数$a$作为函数的输入参数。BRDF可以近似的求出每束光线对一个给定了材质属性的平面上最终反射出来的光线所作出的贡献程度。

Cook-Torrance BRDF：
$$
f_r=k_df_{lambert}+k_sf_{cook-torrance}
$$
这里$k_d$为入射光被折射部分的能量所占的比率，$k_s$为被反射部分的比率。$f_{lambert}$称为Lambert漫反射，用下述公式表示：
$$
f_{lambert}=\dfrac{c}{\pi}
$$
$c$表示表面颜色

BDRF的镜面反射部分表示为：
$$
f_{cook-torrance}=\dfrac{DFG}{4(\omega_0\cdot n)(\omega_i\cdot n)}
$$
DFG分别代表三个函数：

* D：**正态分布函数**，估算在受到表面粗糙度的影响下，取向方向与中间向量一致的微平面的数量。这是用来估算微平面的主要函数
* F：**菲涅尔方程**，菲涅尔方程描述的是在不同的表面角下表面所反射的光线所占的比率
* G：**几何函数**，描述了微平面自成阴影的属性。当一个平面相对比较粗糙的时候，平面表面上的微平面有可能挡住其他的微平面从而减少表面所反射的光线

**正态分布函数**

从统计学上近似的表示了与某些（中间）向量$h$取向一致的微平面的比率
$$
NDF_{GGXTR}(n,h,\alpha)=\dfrac{\alpha^2}{\pi((n\cdot h)^2(\alpha^2-1)+1)^2}
$$
这里$h$表示用来与平面上微平面作比较用的中间向量，$\alpha$表示表面粗糙度

**几何函数**

几何函数从统计学上近似的求得了微平面间相互遮蔽的比率，这种相互遮蔽会损耗光线的能量

![img](https://learnopengl-cn.github.io/img/07/01/geometry_shadowing.png)

这里使用Schlick-GGX：
$$
G_{SchlickGGX}(n,v,k)=\dfrac{n\cdot v}{(n\cdot v)(1-k)+k}
$$
其中，$k$是$\alpha$基于几何函数是针对直接光照还是针对IBL光照的重映射：
$$
k_{direct}=\dfrac{(\alpha+1)^2}{8}\\
k_{IBL}=\dfrac{\alpha^2}{2}
$$
为了有效估算几何部分，需要将观察方向（几何遮蔽）和光线方向（几何阴影）都考虑进去

使用史密斯法：
$$
G(n,v,l,k)=G_{sub}(n,v,k)G_{sub}(n,l,k)
$$
使用史密斯法与Schlick-GGX作为$G_{sub}$可以得到如下所示不同粗糙度的视觉效果

![img](https://learnopengl-cn.github.io/img/07/01/geometry.png)

**菲涅尔方程**

描述的是被反射的光线对比光线被折射的部分所占的比率，这个比率会随着我们观察的角度不同而不同，当光线碰撞到一个表面的时候，菲涅尔方程会根据观察角度告诉我们被反射的光线所占的百分比

Fresnel-Schlick近似菲涅尔方程：
$$
F_{Schlick}(h,v,F_0)=F_0+(1-F_0)(1-(h\cdot v))^5
$$
$F_0$表示平面的基础反射率。

注意，Fresnel-Schlick近似仅对非金属表明有定义，对于金属表面，预先计算出平面对于法向入射的反应（处于0度角，好像直接看向表面一样），然后基于相应观察角的Fresnel-Schlick近似对这个值进行插值。

**Cook-Torrance反射率方程**
$$
L_o(p,\omega_o)=\int_\Omega(k_d\dfrac{c}{\pi}+k_s\dfrac{DFG}{4(\omega_o\cdot n)(\omega_i\cdot n)})L_i(p_i,\omega_i)n\cdot\omega_i\mathrm d\omega_i
$$
