---
bg: "Threshold.jpg"
layout: post
title:  "二值化分割"
crawlertitle: "二值化分割"
summary: "二值化分割"
date:   2018-07-02 20:35:00 +0700
categories: posts
tags: ['数字图像处理']
author: Chaf
---
本文介绍二值化分割的方法
# 一、基本的阈值化  
这里直接给出带阈值化，对于输入图像的每一像素f(i,j)通过以下变换：
\begin{equation}g(i,j)=
\begin{cases}
1& &{f(i,j) \in D}\\\\  
0& &{f(i,j) otherwise}
\end{cases}
\end{equation}
其中除D外的区域都作为背景，由灰度图生成二值化图像。 
OpenCV提供了cv::threshold函数来实现这个功能，原型如下：  
```c++
	double cv::threshold(
		cv::InputAttay		src,			//Input image
		cv::OutputArray		dst,			//Result image
		double				thresh,			//Threshold value
		double 				maxValue,		//Max value for upward operation
		int 				thresholdType	//Threshold type to use
	)
```
其中的thresholdType有以下参数选择：
| Threshold             |                   Operation |
| --------------------- | --------------------------: |
| cv::THRESH_BINARY     | DST=(SRC>thresh)?MAXVALUE:0 |
| cv::THRESH_BINARY_INV | DST=(SRC>thresh)?0:MAXVALUE |
| cv::THRESH_TRUNC      | DST=(SRC>thresh)?THRESH:SRC |
| cv::THRESH_TOZERO     |      DST=(SRC>thresh)?SRC:0 |
| cv::THRESH_TOZERO_INV | DST=(SRC>thresh)?MAXVALUE:0 |

分别使用阈值10，50，100对封面图片选取cv::THRESH_BINARY参数处理得：  
<figure class="Img">
	<img src="/assets/images/Threshold/Simple10.jpg" title='10' width='230'/>
	<img src="/assets/images/Threshold/Simple50.jpg" title='50' width='230'/>
	<img src="/assets/images/Threshold/Simple100.jpg" title='100' width='230'/>
</figure>    

# 二、最优阈值化   
最优阈值化将图像得直方图用两个或更多个正态分布的概率密度函数的加权和来构建。阈值取为离这些正态分布最大值之间的最小概率出最近的灰度值，其结果是具有最小错误的分割。其中一种流行的方法是Otsu算法，简单描述如下：  
1. 给定包含G个灰度级的一幅图像I，计算灰度直方图H(0),H(1),……,H(G-1).通过除以图像的像素个数来归一化直方图。  

2. 对于每一个可能的阈值r=0,……,G-2，将直方图分成背景B(灰度级小于等于t)和前景F（灰度级大于t)。   

3. 计算 \\(\sigma _B (t)\\)和\\(\sigma _F (t)\\)即背景和前景灰度级的方差。计算一个像素是背景的概率$$\omega _B(t)=\sum _{j=0}^{t} H(j)$$ \\(\omega _F (t)\\)的计算方法类似。令$$\sigma (t)=\omega _B (t) \sigma _B ^2 (t) + \omega _F (t) \sigma _F ^2 (t)$$然后选择最优阈值为\\(t=min _t (\sigma (t))\\)。  
    基于OpenCV的Python实现代码：  

  ```python

  def Ostu(img):
      def Histogram(img):
          H = {}
          for i in range(256):
              H[i] = 0
          for i in range(img.shape[0]):
              for j in range(img.shape[1]):
                  H[img[i][j]] += 1
          return H
  
  def w(threshold,H):
      wB=wF=0
      for i in H.keys():
          if i >threshold:
              wF+=H[i]
          else:
              wB+=H[i]
      return wB,wF
  
  def mean(threshold,H):
      F_mean=B_mean=0
      F=B=0
      for i in H.keys():
          if i >threshold:
              F_mean+=H[i]*i
              F+=H[i]
          else:
              B_mean+=H[i]*i
              B+=H[i]
      if F!=0 and B!=0:
          F_mean=F_mean/F;B_mean=B_mean/B
      return B_mean,F_mean
  
  def Var(threshold,F_mean,B_mean):
      sigmaB=sigmaF=0
      for i in H.keys():
          if i >=threshold:
              sigmaF+=(i-F_mean)**2/(img.shape[0]*img.shape[1])
          else:
              sigmaB+=(i-B_mean)**2/(img.shape[0]*img.shape[1])
      return sigmaB,sigmaF
  
  H=Histogram(img)
  sigma_min=t_min=0
  for t in range(255):
      wB,wF=w(t,H)
      wB/=img.shape[0]*img.shape[1]
      wF/= img.shape[0] * img.shape[1]
      B_mean,F_mean=mean(t,H)
      sigmaB,sigmaF=Var(t,B_mean,F_mean)
      sigma=wB*sigmaB+wF*sigmaF
      if t==0:
          sigma_min=sigma
      elif sigma<sigma_min:
          sigma_min=sigma
          t_min=t
  return t_min
  ```
  对封面图用Otsu检测得到的阈值进行分割效果如下（检测值100）：  
  ![](/assets/images/Threshold/Otsu.jpg)

# 三、自适应阈值化  
对于非均匀光照绘制非一致的输入设备参数或其他原因造成的干扰，可以通过变化的阈值即自适应阈值化进行分割，即在图像中的每一个小的区域内分别取阈值，OpenCV提供了cv::adaptiveThreshold函数来实现这一功能，函数原型：  
​	void cv::adaptiveThreshold(
​		cv::InputArray		src,			//Input image
​		cv::OutputArray		dst,			//Result image
​		double				maxValue,		//Max value for upward operations
​		int					adaptiveMethod,	//mean or Gaussian
​		int 					thresholdType,	//Threshold type to use
​		int 					blockSize,		//Block size
​		double 				C,				//Constant
​	)		
取C=5，C=10,C=20均值方式处理效果如下：   

<figure class="Img">
	<img src="/assets/images/Threshold/adaptive_threshold_5.jpg" title='5' width='230'/>
	<img src="/assets/images/Threshold/adaptive_threshold_10.jpg" title='10' width='230'/>
	<img src="/assets/images/Threshold/adaptive_threshold_20.jpg" title='20' width='230'/>
</figure>