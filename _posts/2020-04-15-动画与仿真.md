---
title: 动画与仿真
tags: 计算机图形学
article_header:
  type: cover
  image:
    src: /assets/images/cg.jpg
---

<!--more-->

## 视觉暂留现象

* 光对视网膜所产生的视觉在光停止作用后，仍保留一段时间（0.1-0.4秒左右）的现象
* 原因：视神经的反应速度造成的
* 应用：电影、电视等（每秒24帧）

## 动画

* 视频：图片序列
* 连续播放
	* Frames per second (FPS)，每秒帧数（帧率）

### 传统动画制作过程

* 剧本
* 故事板（草图）
* 造型设计
* 动画设计（关键帧）
* 中间画面（中间帧）
* 样片
* 配音
* 后期制作

### Shape Transformations

* Warping: Unary Op
	* Given Object A and F(t), find Object B

<img src="/assets/images/动画与仿真.assets/image-20200415091256493.png" alt="image-20200415091256493" style="zoom:50%;" />

* Morphing: Binary Op
	* Given Object A and Object B, find F(t)

<img src="/assets/images/动画与仿真.assets/image-20200415091318866.png" alt="image-20200415091318866" style="zoom:50%;" />

### Morphing Problem (关键帧插值)

<img src="/assets/images/动画与仿真.assets/image-20200415091351047.png" alt="image-20200415091351047" style="zoom: 50%;" />

### Two Subproblems

* Correspondence problem
	* find a correspondence between vertices of the two shapes
* Path problem
	* find paths that the corresponding vertices traverse during the morphing process
* Dependent on each other

**Matching**

<img src="/assets/images/动画与仿真.assets/image-20200415091524344.png" alt="image-20200415091524344" style="zoom:50%;" />

<img src="/assets/images/动画与仿真.assets/image-20200415091539010.png" alt="image-20200415091539010" style="zoom:50%;" />

**Path Interpolation Linear vs Non-linear**

<img src="/assets/images/动画与仿真.assets/image-20200415091615029.png" alt="image-20200415091615029" style="zoom:50%;" />

* Wavelet Interpolation

<img src="/assets/images/动画与仿真.assets/image-20200415091645139.png" alt="image-20200415091645139" style="zoom:50%;" />

**Morphing between Different Topologies**

<img src="/assets/images/动画与仿真.assets/image-20200415091829530.png" alt="image-20200415091829530" style="zoom:50%;" />

**Interpolation in Higher Dim**

<img src="/assets/images/动画与仿真.assets/image-20200415091849493.png" alt="image-20200415091849493" style="zoom:50%;" />

<img src="/assets/images/动画与仿真.assets/image-20200415091859326.png" alt="image-20200415091859326" style="zoom:50%;" />

## 基于物理的仿真

### 仿真动画

* 通过计算的方法模拟自然界中的各种物体的形态变换及运动
* 关键：物体形态的变化遵循的物理规律
	* 各种数学物理方程（偏微分方程）
		* 运动学：运动方程
		* 材料力学、弹性力学、流体力学
* 数值计算
	* 微分方程数值解、最优化、并行计算…

### 仿真计算的步骤

<img src="/assets/images/动画与仿真.assets/image-20200415092034730.png" alt="image-20200415092034730" style="zoom:50%;" />

### 形变因素：物质材料

<img src="/assets/images/动画与仿真.assets/image-20200415092057274.png" alt="image-20200415092057274" style="zoom:50%;" />

## 质点-弹簧系统

### 单质点

* 质点
	* 质量$m$
	* 位置$x$
	* 速度$v$
	* 外合力$f=f(x,t)$
* 问题
	* 已知：质点在初始时刻的初始位置$x_0$
	* 预测：质点在下一刻的位置？

<img src="/assets/images/动画与仿真.assets/image-20200415092258117.png" alt="image-20200415092258117" style="zoom:50%;" />

* 牛顿第二定律：$F=ma$

* 求解初值问题
	$$
	x(0)=x_0,\ \ \ \ v(0)=v_0\\
	\frac{d^2x(t)}{dt^2}=\ddot x(t)=\frac{f(x,t)}{m}
	$$
	

<img src="/assets/images/动画与仿真.assets/image-20200415092410579.png" alt="image-20200415092410579" style="zoom:50%;" />

* 将二阶微分方程解耦为一阶微分方程
	$$
	x(0)=x_0,\ \ \ \ v(0)=v_0\\
	\frac{dx(t)}{dt}=\dot{x}(t)=v(t)\\
	\frac{dv(t)}{dt}=\dot v(t)=\frac{f(x,t)}{m}
	$$
	
* 时间离散积分
	$$
	v_{n+1}=v_n+h\int^{t_{n+1}}_{t_n} \frac{f(x,t)}{m}dt\\
	x_{n+1}=x_n+h\int^{t_{n+1}}_{t_n}v(t)dt
	$$
	
* 欧拉半隐式方法离散 (h为时间步长)
	$$
	v(t+h)=v(t)+h\cdot \frac{f(x(t),t)}{m}\\
	x(t+h)=x(t)+h\cdot v(t+h)
	$$
	
* 显式欧拉法
	$$
	x(t+h)=x(t)+h\cdot v(t)\\
	v(t+h)=v(t)+h\cdot \frac{f(x(t),t)}{m}
	$$
	
* 隐式欧拉法
	$$
	x(t+h)=x(t)+h\cdot v(t+h)\\
	v(t+h)=v(t)+h\cdot \frac{f(x(t+h),t+h)}{m}
	$$

### 质点系统 (多质点)

* 牛顿第二定律
	$$
	\boldsymbol M\ddot{\boldsymbol x}(t)=\boldsymbol f(t,\boldsymbol x(t))=\boldsymbol f_{int}(\boldsymbol x(t))+\boldsymbol f_{ext}\\
	\frac{d}{dt}\begin{bmatrix}\boldsymbol x\\\boldsymbol v\end{bmatrix}=\begin{bmatrix}\boldsymbol v\\ \boldsymbol M^{-1}\boldsymbol f\end{bmatrix}
	$$

* 显式欧拉方法
	$$
	\boldsymbol x_{n+1}=\boldsymbol x_n+h\boldsymbol v_n\\
	\boldsymbol v_{n+1}=\boldsymbol v_n+h\boldsymbol M^{-1}\boldsymbol f(t_n)
	$$

* 隐式欧拉方法
	$$
	\boldsymbol x_{n+1}=\boldsymbol x_n+h\boldsymbol v_{n+1}\\
	\boldsymbol v_{n+1}=\boldsymbol v_n+h\boldsymbol M^{-1}\boldsymbol f(t_{n+1})
	$$

* 半隐式欧拉方法
	$$
	\boldsymbol x_{n+1}=\boldsymbol x_n+h\boldsymbol v_n\\
	\boldsymbol v_{n+1}=\boldsymbol v_n+h\boldsymbol M^{-1}\boldsymbol f(t_{n+1})
	$$

### 弹簧-质点

#### 单弹簧

* 胡克定律：$F=kx$

<img src="/assets/images/动画与仿真.assets/image-20200415093357967.png" alt="image-20200415093357967" style="zoom:50%;" />

#### 弹簧质点 

<img src="/assets/images/动画与仿真.assets/image-20200415094307721.png" alt="image-20200415094307721" style="zoom:50%;" />
$$
f_p=k(\|x_p\|-r)\frac{-x_p}{\|x_p\|}\\
f_p=k_s(\frac{\|x_p\|}{r}-1)\frac{-x_p}{\|x_p\|}
$$

#### 弹簧质点对

* 弹簧
	$$
	f_p=k_s\Big(\frac{\|x_q-x_p\|}{r}-1 \Big)\frac{x_q-x_p}{\|x_q-x_p\|}
	$$

* 阻尼 (衰减)
	$$
	f_p=k_d\Big(\frac{v_q-v_p}{r}\cdot \frac{x_q-x_p}{\|x_q-x_p\|} \Big)\frac{x_q-x_p}{\|x_q-x_p\|}
	$$
	
* 合内力
	$$
	f_p=(k_s\Big(\frac{\|x_q-x_p\|}{r}-1\Big)+k_d\Big(\frac{v_q-v_p}{r}\cdot\frac{x_q-x_p}{\|x_q-x_p\|}\Big) )\frac{x_q-x_p}{\|x_q-x_p\|}
	$$

#### 弹簧质点模型

<img src="/assets/images/动画与仿真.assets/image-20200415094351094.png" alt="image-20200415094351094" style="zoom:50%;" />

#### 质点弹簧系统

* 对每根弹簧计算，迭代

<img src="/assets/images/动画与仿真.assets/image-20200415094428856.png" alt="image-20200415094428856" style="zoom:50%;" />

#### 弹簧质点系统的能量法

* 欧拉隐式方法
	$$
	\boldsymbol x_{n+1}=\boldsymbol x_n+h\boldsymbol v_{n+1}\\
	\boldsymbol v_{n+1}=\boldsymbol v_n+h\boldsymbol M^{-1}\boldsymbol f(t_{n+1})\\
	\Rightarrow \boldsymbol x_{n+1}=\boldsymbol x_n+h\boldsymbol v_n+h^2\boldsymbol M^{-1}\boldsymbol f(x_{n+1},t_{n+1})\\
	\boldsymbol v_{n+1}=\frac{\boldsymbol x_{n+1}-\boldsymbol x_n}{h}
	$$
	
* 原问题可转化为求解方程

$$
\boldsymbol x_{n+1}=\boldsymbol y+h^2\boldsymbol  M^{-1}\boldsymbol f_{int}(\boldsymbol x_{n+1})\\
其中，\boldsymbol y=\boldsymbol x_n+h\boldsymbol v_n+h^2\boldsymbol M^{-1}\boldsymbol f_{ext}
$$

* 对于保守力$\boldsymbol f_{int}(\boldsymbol x(t),t)$可以写为$-\nabla E(x)$，这里$E$为势能
	$$
	E(\boldsymbol p_1,\boldsymbol p_2)=\frac{1}{2}k(\|\boldsymbol p_1-\boldsymbol p_2\|-r)^2
	$$

	* 重力可以看做外力，也可以将重力势能加入总势能

* 上述方程可以描述为以下优化问题的解：
	$$
	\boldsymbol x_{n+1}=\arg\min_{\boldsymbol x}\frac{1}{2}(\boldsymbol x-\boldsymbol y)^T\boldsymbol M(\boldsymbol x-\boldsymbol y)+h^2E(\boldsymbol x)
	$$

* 能量极小化求解
	* 如果用Newton-Raphson方法求解即为通常的欧拉隐式方法
	* 其他的优化求解方法：Gradient/Newton/Quasi-Newton etc...

#### 弹簧质点系统的加速方法

##### Mass-Spring System

$$
E(\boldsymbol x_1,\boldsymbol x_2)=\frac{1}{2}k(\|\boldsymbol x_1-\boldsymbol x_2\|-l_0)^2
$$

##### 能量极小化求解

$$
\boldsymbol x_{n+1}=\arg\min_{\boldsymbol x}\frac{1}{2}(\boldsymbol x-\boldsymbol y)^T\boldsymbol M(\boldsymbol x-\boldsymbol y)+h^2E(\boldsymbol x)
$$

* 对每根弹簧：
	$$
	E_i(\boldsymbol x)=\frac{1}{2}k_i(\|\boldsymbol p_{i_1}-\boldsymbol p_{i_2} \|-r_i)^2
	$$

* 加入辅助变量：$\boldsymbol d _i$，满足$\|d_i\|=r_i$

	<img src="/assets/images/动画与仿真.assets/image-20200415095616205.png" alt="image-20200415095616205" style="zoom:50%;" />

* 胡克定律改写为：
	$$
	\frac{1}{2}k_i(\|\boldsymbol p_{i_1}-\boldsymbol p_{i_2} \|-r_i)^2=\frac{1}{2}k_i\min_{\|\boldsymbol d_i\|=r_i}\|\boldsymbol p_{i_1}-\boldsymbol p_{i_2}-\boldsymbol d_i \|^2
	$$

* 当$d_i=r_i\frac{p_{i_1}-p_{i_2}}{\|p_{i_1}-p_{i_2}\|}$ 时，上述优化问题取得等号

	<img src="/assets/images/动画与仿真.assets/image-20200415095854699.png" alt="image-20200415095854699" style="zoom: 50%;" />

* 时间积分
	$$
	\min_{\boldsymbol x}\frac{1}{2}(\boldsymbol x-\boldsymbol y)^T\boldsymbol M(\boldsymbol x-\boldsymbol y)+h^2E(\boldsymbol x)\\
	\Rightarrow \min_{\boldsymbol x,\boldsymbol d\in \boldsymbol U} \frac{1}{2} \boldsymbol x^T\boldsymbol A\boldsymbol x+\boldsymbol x^T(\boldsymbol B\boldsymbol d+\boldsymbol c)
	$$
	其中，$U=\{\boldsymbol d=(\boldsymbol d_1,\boldsymbol d_2,\cdots,\boldsymbol d_s),\boldsymbol d_i\in R^3,\|\boldsymbol d_i\|=r_i\}$

* 优化
	$$
	\min_{\boldsymbol x,\boldsymbol d\in \boldsymbol U} \frac{1}{2} \boldsymbol x^T\boldsymbol A\boldsymbol x+\boldsymbol x^T(\boldsymbol B\boldsymbol d+\boldsymbol c)
	$$
	$A$，$B$，$c$为常量，不依赖于$x$，$d$

* Local/global 优化方法
	* 固定$x$，$d$容易优化
	* 固定$d$，$x$容易优化

* Local step：由当前$x$求$d$（归一化）
	$$
	d_i=r_i\frac{p_{i_1}-p_{i_2}}{\|p_{i_1}-p_{i_2}\|}
	$$

	* 可以并行优化

* Global step：$x^*=-A^{-1}(Bd+c)$

	其中矩阵$A$为常量，且为正定矩阵，故优化可以进行预分解

### Demo

[Demo](https://chaphlagical.github.io/external/CG_Demo/MassSpring.html)

### 一般线性系统

* 运动方程
	$$
	\boldsymbol K(\boldsymbol x-\boldsymbol u)+\boldsymbol {Dv}+\boldsymbol {Ma}=\boldsymbol f_{ext}
	$$

* $\boldsymbol K=-\frac{\partial \boldsymbol f_{int}}{\partial \boldsymbol x}$：刚度矩阵，$\boldsymbol D$：阻尼

* $\boldsymbol u$为初始位置，令$\boldsymbol d=\boldsymbol x-\boldsymbol u$ 
	$$
	\boldsymbol K(\boldsymbol d)+\boldsymbol {Dd}+\boldsymbol {Md}=\boldsymbol f_{ext}
	$$

## 刚体运动仿真

* 将弹簧质点系统中的弹力替换为质点间的约束

<img src="/assets/images/动画与仿真.assets/image-20200415100942657.png" alt="image-20200415100942657" style="zoom:50%;" />

* 6个自由度：位移$x$, 朝向$R$

<img src="/assets/images/动画与仿真.assets/image-20200415101012399.png" alt="image-20200415101012399" style="zoom:50%;" />

* 质心：$\boldsymbol x_{com}=\frac{\sum^N_{i=1}m_ip_i}{\sum_{i=1}^N m_i}$

<img src="/assets/images/动画与仿真.assets/image-20200415101108643.png" alt="image-20200415101108643" style="zoom:50%;" />

* 质点的坐标表示

<img src="/assets/images/动画与仿真.assets/image-20200415101127910.png" alt="image-20200415101127910" style="zoom:50%;" />

* 位移：$p(t)=x(t)+r(t)=x(t)+R(t)r_0$

* 速度：
	$$
	v(t)=\dot{p}(t)=\dot{x}(t)+\dot{R}(t)r_0\\
	\dot{R}(t)r_0=\omega(t)\times r(t)\\
	v(t)=\dot{x}(t)+\omega(t)\times r(t)
	$$
	其中$\omega(t)$为刚体角速度

* 动量
	$$
	P(t)=M\dot{x}(t)\\
	M=\sum^N_{i=1}m_i
	$$
	$m_i$为刚体总质量

* 角动量
	$$
	L(t)=I(t)\omega(t)\\
	I(t)=R(t)I_0R(t)^T
	$$
	其中$I(t)$为刚体转动惯量，$I_0(t)$为初始时刻的转动惯量

* 运动方程
	$$
	\frac{d}{dt}\begin{bmatrix}\boldsymbol x(t)\\\boldsymbol R(t)\\\boldsymbol P(t)\\\boldsymbol L(t) \end{bmatrix}=\begin{bmatrix}\boldsymbol v(t)\\\boldsymbol \omega^*\boldsymbol R(t)\\\boldsymbol f(t)\\\boldsymbol \tau(t)  \end{bmatrix}
	$$
	其中$\boldsymbol \omega^*\in \boldsymbol R^{3\times 3}$满足$\boldsymbol \omega^*\boldsymbol x=\boldsymbol \omega\times\boldsymbol x,\forall \boldsymbol x\in \boldsymbol R^3$，$\boldsymbol\tau(t)$为外力矩