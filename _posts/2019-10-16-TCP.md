---
title: TCP
tags: 计算机网络
article_header:
  type: cover
  image:
    src: /assets/images/computer_network.jpg
---

本文介绍TCP协议

## TCP协议的socket编程

### （一）基本过程

  **服务器首先运行，等待连接建立**

#### 1：服务器进程必须先处于运行状态

* 创建欢迎socket

* 和本地端口捆绑

* 在欢迎socket上阻塞式等待接收用户的连接

**客户端主动和服务器建立连接：**

#### 2：创建客户端本地套接字（隐式捆绑到本地port） 

* 指定服务器进程的IP地址和端口号，与服务器进程连接

  #### 3：当与客户端连接请求到来时

* 服务器接受来自用户端的请求，解除阻塞式等待，返回一个新的socket（与欢迎socket不一样），与客户端通信允许服务器与多个客户通信
  
  * 使用源IP和源端口来区分不同的客户端 

#### 4：连接API调用有效时，客户端P与服务器建立了TCP连接

### （二）C/S socket 交互

![](/assets/images/socket/TCP/1.jpg)

### （三）相关数据结构（C语言）

#### 1、  sockaddr_in

  IP地址和port捆绑关系的数据结构（标示进程的端节点）  

```c
struct sockaddr_in {
    short sin_family; //AF_INET
    u_short sin_port; // port
    struct in_addr sin_addr ;
    // IP address, unsigned long
    char sin_zero[8]; // align
};
```

#### 2、  hostent  

  域名和IP地址的数据结构  

 ```c
struct hostent{ 
    char *h_name;
    char **h_aliases;
    int h_addrtype;
    int h_length; /*地址长度*/
    char **h_addr_list;
    #define h_addr h_addr_list[0];
}
 ```

作为调用域名解析函数时的参数，返回后，将IP地址拷贝到 sockaddr_in的IP地址部分  

### （四）例程

**C语言实现TCP客户端**

```c
/* client.c */
void main(int argc, char *argv[]){
    struct sockaddr_in sad; /* structure to hold an IP address of server */
    int clientSocket; /* socket descriptor */
    struct hostent *ptrh; /* pointer to a host table entry */
    
    char Sentence[128];
    char modifiedSentence[128];
    
    host = argv[1]; port = atoi(argv[2]);
    
    /***Create client socket,connect to server***/
    clientSocket = socket(PF_INET, SOCK_STREAM, 0);
    memset((char *)&sad,0,sizeof(sad)); /* clear sockaddr structure */
    sad.sin_family = AF_INET; /* set family to Internet */
    sad.sin_port = htons((u_short)port);
    ptrh = gethostbyname(host);
    /* Convert host name to IP address */
    memcpy(&sad.sin_addr, ptrh->h_addr, ptrh->h_length);
    //将IP地址拷贝到sad.sin_addr
    connect(clientSocket, (struct sockaddr *)&sad, sizeof(sad));
    
    gets(Sentence); //Get input stream from user
    n=write(clientSocket, Sentence, strlen(Sentence)+1); //Send line to server
    n=read(clientSocket, modifiedSentence, sizeof(modifiedSentence)); //Read line from server
    printf("FROM SERVER: %s\n”,modifiedSentence); 
    close(clientSocket); //close connection
}
```

**C语言实现TCP服务端**

```c
/* server.c */
void main(int argc, char *argv[]){
    struct sockaddr_in sad; /* structure to hold an IP address of server*/
    struct sockaddr_in cad; /*client */
    int welcomeSocket, connectionSocket; /* socket descriptor */
    struct hostent *ptrh; /* pointer to a host table entry */
    
    char clientSentence[128];
    char capitalizedSentence[128];
    
    port = atoi(argv[1]);
    
    /**Create welcoming socket at port & Bind a local address**/
    welcomeSocket = socket(PF_INET, SOCK_STREAM, 0);
    memset((char *)&sad,0,sizeof(sad)); /* clear sockaddr structure */
    sad.sin_family = AF_INET; /* set family to Internet */
    sad.sin_addr.s_addr = INADDR_ANY; /* set the local IP address */
    sad.sin_port = htons((u_short)port);/* set the port number */
    bind(welcomeSocket, (struct sockaddr *)&sad, sizeof(sad))
        
    /* Specify the maximum number of clients that can be queued */
    listen(welcomeSocket, 10)
    while(1) {
        //Wait, on welcoming socket for contact by a client
        connectionSocket=accept(welcomeSocket, (struct sockaddr *)&cad, &alen); 
        n=read(connectionSocket, clientSentence, sizeof(clientSentence));
        /* capitalize Sentence and store the result in capitalizedSentence*/
        //Write out the result to socket
        n=write(connectionSocket, capitalizedSentence, strlen(capitalizedSentence)+1); 
        //End of while loop, loop back and wait for another client connection
        close(connectionSocket); 
	}
}

```

