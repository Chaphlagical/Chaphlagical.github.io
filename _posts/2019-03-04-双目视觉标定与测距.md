---
bg: "2019-03-04.jpg"
layout: post
title:  "双目视觉标定"
crawlertitle: "双目视觉标定"
summary: "双目视觉标定"
date:   2019-03-04 17:03:10 +0700
categories: posts
tags: ['计算机视觉']
author: Chaf
---

本文介绍双目视觉标定原理

## 一、坐标系

双目视觉中有三类坐标系：

**1、世界坐标系$\{World\}(x_w,y_w,z_w)$** ：目标物体位置的参考系。

**2、摄像机坐标系$\{Camera\}(x_c,y_c,z_c)$** ：从摄像机角度衡量物体位置的坐标系，摄像机坐标系的原点在摄像机的光心上，z轴与摄像机光轴平行。

**3、图像坐标系$\{Picture\}(x_p,y_p)$** ：以摄像机拍摄的二维照片为基准建立的坐标系。用于指定物体在照片中的位置。

**4、像素坐标系$\{Pixel\}(x_{pix},y_{pix})$**：图像中以像素为单位的坐标

## 二、世界坐标系$\{ World \}$到摄像机坐标系$\{ camera \}$的转换

设某点在世界坐标系$\{World\}$中的坐标为$P_W=[x_w,y_w,z_w]^T$，该点在左右摄像机坐标系$\{Camera\}$中的坐标分别为$P_{lC}=[x_{lx},y_{lc},z_{lc}]^T$和$P_{rC}=[x_{rc},y_{rc},z_{rc}]^T$，则有：

$P_{lC}=\begin{bmatrix}R_l&T_l\\\\0&1\end{bmatrix}P_W$ 和 $P_{rC}=\begin{bmatrix}R_r&T_r\\\\0&1\end{bmatrix}P_W$

其中$R_r$和$R_l$是正交旋转矩阵，需要三个外参确定：

$R=\begin{bmatrix}r_{11}&r_{12}&r_{13}\\\\r_{21}&r_{22}&r_{23}\\\\r_{31}&r_{32}&r_{33}\end{bmatrix}$

$T_r$和$T_l$是平移矩阵，需要三个外参确定：

$T=[t_x,t_y,t_z]^T$

## 三、摄像机坐标系$\{ camera \}$到图像坐标系$\{ picture \}$的转换

由三角形相似原理：

$\begin{cases}x_p=f\frac{x_c}{z_c}\\\\y_p=f\frac{y_c}{z_c}\end{cases}$ 矩阵形式表示为：$z_c\begin{bmatrix} x_p\\\\y_p\end{bmatrix}=\begin{bmatrix}f&0\\\\0&f\end{bmatrix}\begin{bmatrix}x_c\\\\y_c\end{bmatrix}$

## 四、图像坐标系$\{ picture \}$到像素坐标系$\{ pixel \}$的转换

$s_x$表示$X_{pix}$方向上单位mm的像素数,单位是pix/mm
$x_y$表示$Y_{pix}$方向上单位mm的像素数,单位是pix/mm
$x_0$ , $y_0$表示投影平面中心在像素坐标系{pixel}中的坐标,则有

$\begin{cases} x_{pix}=x_0+x_ps_x \\\\  y_{pix}=y_0+y_ps_y\end{cases}$ 矩阵形式：$\begin{bmatrix}x_{pix}\\\\y_{pix}\\\\1\end{bmatrix}=\begin{bmatrix}s_x&0&x_0\\\\0&s_y&y_0\\\\0&0&1\end{bmatrix}\begin{bmatrix}x_p\\\\y_p\\\\1\end{bmatrix}$

## 五、世界坐标系$\{ World  \}$到像素坐标系$\{ Pixel \}$的转换

记$\begin{cases} f_x=fs_x \\\\ f_y=fs_y\end{cases}$分别表示焦距$f$在$X_{pix}$和$Y_{pix}$方向的等效焦距，单位是$pix$，结合各式得

$z_c \begin{bmatrix} x_{pix}\\\\y_{pix}\\\\1\end{bmatrix}=\begin{bmatrix} f_x&0&x_0&0\\\\0&f_y&y_0&0\\\\0&0&1&0\end{bmatrix}\begin{bmatrix}R&T\\\\0&1\end{bmatrix}\begin{bmatrix}x_w\\\\y_w\\\\z_w\\\\1\end{bmatrix}$

## 六、摄像机透镜畸变

#### 1、径向畸变

径向畸变会产生“鱼眼”现象。成像中心处径向畸变为0,径向畸变随着与成像中心距离增大而增大,在图像边缘处达到最大径向畸变。常常用偶次幂的泰勒公式描述径向畸变：

$\begin{cases}x_{corrected}=x(1+k_1r^2+k_2r^4+k_3r^6)\\\\x_{corrected}=y(1+k_1r^2+k_2r^4+k_3r^6)\end{cases}$

#### 2、切向畸变

切向畸变由透镜和成像平面不平行引起。常用如下公式描述
$\begin{cases}x_{corrected}=x+[2p_1y+p_2(r^2+2x^2)]\\\\x_{corrected}=y+[p_1(r^2+2y^2)+2p_2x]\end{cases}$​

#### 3、畸变校正

单目摄像机畸变校正需要确定$k_1,k_2,k_3,p_1,p$五个参数 

## 七、左右摄像机坐标系$\{ camera  \}$转换（旋转矩阵R和平移矩阵T）

假设空间中有一点P，其在世界坐标系$\{World\}$下的坐标为$P_W$，其在左右摄像机坐标系$\{Camera\}$下的坐标可表示为：

$\begin{cases}P_l=R_lP_W+T_l\\\\P_r=R_rP_W+T_r\end{cases}$矩阵形式表示为：$\begin{bmatrix} P_l\\\\P_r\\\\1\end{bmatrix}=\begin{bmatrix}P_W&0&T_l\\\\0&P_W&T_r\\\\0&0&1\end{bmatrix}\begin{bmatrix}R_l\\\\R_r\\\\1\end{bmatrix}$ 

设旋转矩阵为$R$，平移矩阵为$T$，$P_l$和$P_r$有关系：

$P_r=RP_l+T$（$R$和$T$均为从左向右转换），联立解得：

$\begin{cases}R=R_rR_l^T\\\\T=T_r-RT_l\end{cases}$

通过单目标定相机外参数$R_l，T_l，R_r$和$T_r$，代入求解。

## 八、左右图像坐标系$\{ picture \}$的转换（本征矩阵$E$）

本征矩阵是左右图像坐标系$\{Picture\}$相互转换的矩阵，描述左右摄像机图像平面上对应点的关系，用$E$表示。

假设空间中有一点$P$，其在世界坐标系$\{World\}$下的坐标为$P_W$，其在左右摄像机坐标系$\{Camera\}$下的坐标表示为$P_l$和$P_r$，右摄像机坐标系原点在左摄像机坐标系的坐标为$T=[T_x,T_y,T_z]^T$，则有：

$P_r=R(P_l-T_r)$则通过点$T_r$的所有点的$P_l$所组成的平面（极面）可以用下式表示：

$(P_l-T_r)^T(P_l\times T_r)=0$将$P_l\times T_r$写成矩阵相乘的形式：$P_l\times T_r=SP_l$

其中S为：

$S=\begin{bmatrix}0&-T_x&T_y\\\\T_z&0&-T_x\\\\-T_y&T_x&0\end{bmatrix} $

联立得：$P_r^TRSP_l=0$

本征矩阵$E=RS$，原方程可化为$P^T_{pr}EP_{pl}=0$，该方程描述了同一物理点在左右摄像机图像坐标下的关系

## 九、左右像素坐标系$\{ pixel \}$的转换（基础矩阵F）

设相机内参数矩阵为$M$，由$P_{pix}=MP_p$ 得：

$P_{pix}^T(M_r^{-1})EM_l^{-1}P_{pix}=0$

定义基础矩阵$F=(M_r^{-1})EM_l^{-1}$

同一物理点在左右摄像机像素坐标系$\{ pixel \}$的关系：$P_{pix}^TFP_{pix}=0$

