---
title: 总线和接口
tags: 微机原理与嵌入式系统
article_header:
  type: cover
  image:
    src: /assets/images/embed.jpg
---

<!--more-->

[课程地址1](https://www.eeo.cn/live.php?lessonKey=f32103d3560a17e9) 

[课程链接2](https://www.eeo.cn/live.php?lessonKey=91b5cfb858eb9c97)

## 一、总线技术

### (一) 总线技术概述

#### 1、总线的概念

##### (1) 总线的作用

总线：计算机系统内部或者计算机系统之间传输信息的公共信道。总线是由一些电导体的互连组成，其具体形式可以是印刷线路、各种连接器、多路电缆等。

* 系统早期的互联方式——分散连接
	* 内部连线十分复杂，布线困难，扩展性差
	* 效率高
* 现代的系统互联方式——总线连接
	* 优点：简洁，协调扩展性好
	* 缺点：有共享竞争问题

##### (2) 接口的作用

* 计算机数据处理过程中存在大量数据交换
	* CPU和计算机其他部件/外设之间
	* 计算机不同部件/外设间：内存到显卡、网卡到内存...
* 外部设备种类繁多、差异大
	* 信号形式：数字/模拟、电压/电流...
	* 速度：摄像头30帧/s、键盘2-6次/s、打印机1-30页/s...
* 需要中间环节来协调
	* 中间环节就是输入/输出（Input/Output，I/O）接口
	* 接口电路起转换、缓冲速度匹配作用

##### (3) 总线与接口的区别与联系

* 电路单元之间的硬件电路
	* 接口包括了电路单元之间的硬件电路。
	* 总线不仅包括分时共享传输线路和相关电路，也包括传输和管理信息的规则（即协议）。
	* 挂接在总线上的电路单元一定需要相应的接口电路。
* 点到点连接和多点互联
	* 两个电路单元连接需要接口电路，未必需要总线协议。
	* 多个电路单元互联，每个电路单元不仅要有接口电路，还需要按照总线协议来规范。
* 有时候并不做严格区分
	* 广义的接口还包括了接口电路相应的驱动程序

##### (4) 采用总线的原因

考虑一个具有$N$个电路模块的计算机系统，若模块间两两采用直接连接的方式，则实现所有模块互联共需要$N×(N-1)/2$组连接线

##### (5)总线的基本特性

* 总线的两个基本特性：共享、分时
* 共享：当多个部件连接在同一组总线上，各部件之间相互交换的信息都可以通过这组总线传送。
	* 正是由于共享特性而使得总线富有生命力
* 分时：是指任意时刻只能有一个设备向总线发送信息，但是允许多个部件同时从总线接受相同信息（广播）。
	* 分时是制约系统性能的瓶颈

##### (6) 总线主要性能指标

**总线频率**

* 每秒能够发起数据传输的最大次数（Transfer/s，T/s），也称总线传输速率，常用单位MHz
* 许多总线每个时钟周期能发起一次传送，总线频率就等于总线时钟频率
* 总线频率越高，传输速度越快
* 如ISA/EISA的总线频率为8MHz，PCI有33.3MHz和66.6MHz两种总线频率

**总线宽度**

* 总线可同时传输的数据位数，也称总线位宽。例如，8位总线、16位总线、32位总线等。
* 总线越宽，相同时间内能传输更多的数据

**总线带宽**

* 又称总线最大数据传输速率，单位MB/s。影响带宽的因素有总线宽度、总线频率等，并行总线的带宽为：   

	带宽（MB/s）=总线宽度/8×总线频率

* 例：求33.3MHz@32位总线的带宽。

	总线带宽=32b/8×33.3 MHz =133.2MB/s

* 并行总线一次能传输多位数据，但信号间存在干扰，频率越高，位宽越大，干扰越严重，带宽难于提高。

* 串行总线可通过较高的总线频率获得较大的总线带宽。此外，为弥补一次只能传送一位数据的不足，串行总线常用多条管线传输，其带宽为：

	带宽=总线频率×管线数

**同步方式**

* 同步总线：主、从模块之间严格按照确定的时钟进行数据传输，传送速率较高，但是对模块的速度有要求。
* 异步总线：主、从模块之间通过应答握手确保可靠传送，适应性广，灵活性高，但会减小总线带宽

**总线复用**

在一条线路上，不同的时刻传送不同的内容，例如某一时刻传输地址，另一时刻传输数据或命令信号，以减少总线的信号线数量，并提高信号线的利用率

**信号线数**

数据、地址、控制和电源总线数的总和。信号线数量与总线的性能不成正比

**总线控制方式**

包括并发工作、自动配置、仲裁方式、逻辑方式、计数方式等

**寻址能力**

指地址总线的位数及所能直接寻址的存储器空间大小

**总线的定时协议**

为使源与目的同步，需要有信息传送的时间协议。分为同步总线定时、异步总线定时、半同步总线定时

**负载能力**

指总线上最多能连接的器件数，一般指总线上的扩展槽的个数

##### (7) 总线特性

* 为了保证总线与部件之间机械上的可靠连接，必须规定其机械特性
* 为了保证电气上正确连接，必须规定其电气特性
* 为了正确传输信息，必须规定其功能特性和规程特性

#### 2、总线的分类

总线有多种分类方法，例如：

* 按照物理接口分类
	* 电缆式、主板式、背板式
* 根据总线信号传输类型
	* 分为数据总线、地址总线、控制总线和电源总线
* 按照控制特性分类
	* 同步总线、异步总线和半同步总线
* 按照通信方式分类
	* 串行总线和并行总线

##### (1) 总线按位置分类

* 片内总线（In Chip Bus），位于芯片（CPU或其他的处理器）的内部，连接CPU内部的各个部件
* 芯间总线（Chip Bus），也称为芯片总线（Component-Level Bus）或者局部总线（Local Bus），连接CPU和外围芯片
* 内总线（Internal Bus），又称为板级总线（Board-Level Bus）或系统总线（System Bus），用于系统内部各高速模块之间的互连。例如ISA、EISA、PCI等
* 外总线（External Bus），又称I/O总线或通信总线（Communication Bus），用于计算机之间，或者计算机与外设之间的互连。例如SCSI、USB等

**片上总线**

* 近年来，随着片上系统SoC（System On Chip）的迅速发展，在单颗芯片上不仅仅集成了计算机的CPU，也可以集成存储器，甚至集成了过去以外设形式存在的GPS、蓝牙模块等。
* 上述片内总线、芯间总线、内总线、外总线的区分方式在基于SoC的嵌入式系统中，不完全适用。逐渐采用术语“片上总线（on-chip bus）”来描述芯片内部（事实上涵盖了传统内总线及外总线的定义）使用的总线。
* 典型的片上总线如ARM处理器的AMBA总线，AMBA总线兼顾了早期计算机系统中内总线和外总线的适用范围

**总线的层次结构**

* 计算机系统内同时存在多条总线，通常采用多级分层结构

<img src="/assets/images/总线和接口.assets/image-20200316232909775.png" alt="image-20200316232909775" style="zoom:67%;" />

**外总线的分层结构**

* 由于外设种类繁多，速率不一，通用计算机外部总线也采用层次化的结构

<img src="/assets/images/总线和接口.assets/image-20200316233124949.png" alt="image-20200316233124949" style="zoom:50%;" />

##### (2) 总线按功能分类

* 地址总线（AB，Address Bus）专门用来传送地址
	* 地址总线宽度决定了最大存储器空间寻址范围（20位宽度的地址总线可寻址空间为$2^{20}=1M$）
* 数据总线（DB，Data Bus）用于传送数据信息
	* 双向三态
	* 通常与微处理器的字长相一致
	* 带宽(B/s)=总线宽度/8X总线频率
* 控制总线（CB，Control Bus）用来传送控制信号和时序信号

<img src="/assets/images/总线和接口.assets/image-20200316233521896.png" alt="image-20200316233521896" style="zoom:50%;" />

##### (3) 总线按数据传输方式分类

* 串行传输，串行总线（serial bus）

	* 串行总线只用一根信号线（如果传输的是差分信号则是两根信号线）来传输数据
	* 需传输的比特串一个接一个地在一条信道上传输

	<img src="/assets/images/总线和接口.assets/image-20200316234916519.png" alt="image-20200316234916519" style="zoom:50%;" />

* 并行传输，并行总线（parallel bus）

	* 比特以成组的方式在两条或更多的并列信道上进行传输
	* 一般为一字节或多字节，其位数为该总线的宽度

	<img src="/assets/images/总线和接口.assets/image-20200316234927736.png" alt="image-20200316234927736" style="zoom:50%;" />
	
	（过去，内总线一般为并行总线，系统外总线多采用串行总线）

##### (4) 总线按时序控制方式分类

* 异步总线
	
	* 传输的双方有各自独立的定时时钟
	* 通过主从双方的“握手”应答机制进行数据传输
	* 传输可靠性高
	* 但是握手应答导致速度较慢，例如Motorola公司的VME总线
	
	<img src="/assets/images/总线和接口.assets/image-20200316235348175.png" alt="image-20200316235348175" style="zoom:50%;" />
	
* 同步总线
	* 所有挂接在总线上的设备，按照统一的时钟，在规定时间完成规定的工作
	* 需要独立的信号线来传输时钟
	* 没有握手应答过程，速度快
	* 所有部件的速度应该相对一致
	* 可靠性不如异步总线
* 为了照顾少数低速设备，采用“就绪-等待”机制——半同步总线
	
	<img src="/assets/images/总线和接口.assets/image-20200316235407219.png" alt="image-20200316235407219" style="zoom:50%;" />

##### (5) 总线按时分复用分类

* 非复用
	* 每条信号线的功能恒定
	* 缺点是总线上的信号线数量较多
* 复用
	* 某些信号线在不同时段传输不同类型的信号，旨在减少信号线的数量
	* 如何区分信号线上到底传输的是什么信号呢？
		*  **约定**。例如PCI总线上的AD[31:0]是32根地址和数据复用的信号线，按照数据传送的规律，首先传送地址，然后再传送数据
		* **增加专用信号线加以标识**，如下图所示

<img src="/assets/images/总线和接口.assets/image-20200316235600933.png" alt="image-20200316235600933" style="zoom:50%;" />

#### 3、总线的结构

##### (1) 单总线

* 将CPU、主存、I/O接口等都挂到一组总线上，CPU与内存以及与I/O之间访问都通过同一条总线
* 优点是结构简单，但这种方式如同机动车、非机动以及行人不加区分的混合交通，影响了CPU与存储器之间的数据存取速度

<img src="/assets/images/总线和接口.assets/image-20200317000853358.png" alt="image-20200317000853358" style="zoom: 50%;" />

* 为解决CPU与主存以及与IO设备之间传输速率的不匹配问题，又出现了双总线结构

##### (2) 双总线：面向CPU的双总线结构

* 思想：设置一条与主存总线独立的I/O总线，专门连接速度低的I/O接口

<img src="/assets/images/总线和接口.assets/image-20200317001044853.png" alt="image-20200317001044853" style="zoom:50%;" />

* 优点：在CPU与主存储器之间、CPU与I/O设备之间分别设置了总线，提高了微机系统信息传送的速率和效率
* 缺点：但外部设备与主存储器之间没有直接的通路，它们之间的信息交换必须通过CPU才能进行中转，会降低了CPU的工作效率，这是面向CPU的双总线结构的主要缺点

##### (3) 双总线：面向存储器的双总线结构

* 在CPU与存储器之间，专门设置了一条高速存储总线，使CPU可以通过它直接与存储器交换信息

<img src="/assets/images/总线和接口.assets/image-20200317001149503.png" alt="image-20200317001149503" style="zoom:50%;" />

* 优点：面向存储器的双总线结构信息传送效率较高
* 缺点：I/O接口与存储器交换信息时，速度仍然较慢

##### (4) 典型的三总线结构

* **主存总线**，连接CPU与主存
* **I/O总线**，I/O总线只有在CPU执行I/O指令时才能用到
* **DMA总线**，为高速I/O设备建立了一个到达主存的高速通道，称为DMA（Direct Memory Access，直接存储访问）总线

<img src="/assets/images/总线和接口.assets/image-20200317001302390.png" alt="image-20200317001302390" style="zoom:50%;" />

但是，任意时刻只有一套总线能用，主存总线与DMA总线不能同时对主存进行访问

##### (5) 四总线

* 局部总线、系统总线、高速总线、扩展总线
* 增加了一条与系统相连的高速总线，连接高速的I/O设备
* 较低速度的设备则放在了扩展总线上

<img src="/assets/images/总线和接口.assets/image-20200317001353864.png" alt="image-20200317001353864" style="zoom:50%;" />

### (二) 总线仲裁

**总线上的设备**

* 总线上的设备一般分为总线主设备（主控模块）和总线从设备（从属模块）。常把总线主设备称作总线主机，把总线从设备称作总线从机
* 总线主设备是指具有控制总线能力的模块，在获得总线控制权之后能启动数据的传输；从设备能够对总线上的数据请求做出响应，但本身不具备总线控制能力
* 早期，一条总线上只有一个主设备，后来，多个主设备共享总线的情况越来越普遍
* 总线仲裁（bus arbitration）就是在多总线主设备的环境中提出来的

**总线仲裁**

* 总线的使用权分配即总线判优控制，也称为总线使用权仲裁。当有多个主设备同时申请总线时，按一定的优先等级顺序，判定哪个主设备能优先使用总线
* 两种仲裁方式
	* 集中式：将控制逻辑（即总线仲裁器arbitrator）集中在一处，分为串行仲裁、并行仲裁、循环优先权以及串并行混合等方式
	* 分布式：将控制逻辑分散在（与总线连接的）各个部件或设备上，由各个节点按照事先约定的协议，竞争使用权

#### 1、集中式仲裁

##### (1) 串行仲裁

* 串行仲裁最为常见的是“链式”（Daisy Chainning）仲裁。信号线包括：总线请求BR（Bus Request）信号、总线允许BG（Bus Grant）信号和总线忙BS（Bus Busy）信号
	* BB无效（总线空闲）时，主设备才能提出总线请求。各主设备的BR信号用“线与”方式接到仲裁器的请求输入端。仲裁器在接到BR信号后输出BG信号，BG信号通过主设备链向后逐个传递，直到提出总线请求的那个设备为止。请求总线的主设备收到BG号后，获得总线的控制权，将BS信号置为有效

<img src="/assets/images/总线和接口.assets/image-20200317001734647.png" alt="image-20200317001734647" style="zoom:50%;" />

* 特点
	* 越靠近控制器的模块，优先级越高
	* 链形优先级存在传播延迟，这种延迟与模块数量成正比，仲裁较慢。由于总线申请和使用权分配必须在一个时钟周期内完成，受总线周期的限制，一般只能接少量的（几个）模块
		* 例如：VME总线的时钟周期为50ns，而主设备链的传输延迟一般为15ns，因此，采用链式仲裁的主设备不能超过3个
	* 链形结构可靠性低，一个模块有故障就会造成整条“链”失效
	* 结构简单，造价较低
	* 应用实例：
		* Intel  MultiBus
		* MotorolaVME总线

##### (2) 并行仲裁

* 并行仲裁又称为“独立请求式仲裁”。每个主设备都有独立的BR和BG信号线，并分别接到仲裁器上
	* 任一主设备使用总线都要通过BR信号向仲裁器发出请求，仲裁器按规定的优先级算法选中一个主设备，并把BG信号送给该设备。被选中的设备撤销BR信号，并输出有效的BS信号，通知其他设备“总线已经被占用”

<img src="/assets/images/总线和接口.assets/image-20200317001907086.png" alt="image-20200317001907086" style="zoom:50%;" />

* 特点
	* 独立请求方式的工作原理：
		* 每个模块有一条总线请求（BR）、一条总线允许（BG）和一条所有模块共用的总线忙（BUSY）信号
		* 控制器内置一个优先级编码器和优先级译码器，用以选择优先级最高的请求，并产生出相应的“总线允许”信号
		* 当BUSY信号有效时，表示有模块正使用总线，因此请求使用总线的模块必须等待，直至BUSY信号变为无效。所有需要使用总线的模块都可发“总线请求”信号，总线仲裁器仅向优先级最高的模块发出“总线允许”信号
	* 独立请求方式的主要特点：
		* 判优速度快，且与模块数无关
		* 所需“请求线”和“允许线”较多，N个模块需要2N条

#### 2、分布式仲裁

##### (1) 自举分布式仲裁

* 特点：使用多个请求线，不需要中心裁决器，每个设备独立地决定自己是否是最高优先级请求者。
* 原理：分为申请期和裁决期。在申请期需要请求总线控制权的设备在各自对应的总线请求线上送出请求信号。在裁决期，每个设备将有关请求线上的合成信号取回分析，以确定自己能否拥有总线控制权。
* 每个设备通过取回的合成信息能够检测出其它设备是否发出了总线请求。如果检测到其它优先级更高的设备也请求使用总线，则本设备暂时不能使用总线；否则，本设备就可立即使用总线
* 原理图
	* 假定模块1～4通过BR~1～4~进行自举分布式仲裁。其中BR~1~为总线忙信号，正在使用总线的模块应将BR~1~置为有效；BR~i~为模块i的总线请求信号线，只有在BR~1~无效时才能发总线请求。下图中设备1的优先级最低，设备4的优先级最高。

<img src="/assets/images/总线和接口.assets/image-20200317002200396.png" alt="image-20200317002200396" style="zoom:50%;" />

* 应用实例：NuBus（Macintoshi II中的底板式总线）和SCSI总线

### (三) 总线操作与时序

**总线操作**

* 总线操作与总线周期
	* 通过总线进行信息交换的过程称为总线操作。总线设备完成一次完整信息交换的时间称为总线周期（或总线传输周期）。
* 总线周期的4个阶段
	* 请求及仲裁（Request and Arbitration）阶段。主模块请求，仲裁机构决定把下一个总线传输周期分给哪一个请求源
	* 寻址（Addressing）阶段。取得总线使用权的主模块通过总线发出本次要访问的从模块（存储器地址或I/O端口）地址及有关命令，通知参与传输的从模块开始启动
	* 数据传输（Data Transferring）阶段。主模块和从模块进行数据传输，数据由源模块发出，经数据总线到达目的模块
	* 结束阶段。主模块、从模块的有关信息均从总线上撤销，让出总线，以便下一个总线传输周期其他模块能够使用总线

**总线操作的时序**

* 总线操作包括：读/写存储器周期、读/写I/O端口周期、DMA周期、中断周期等。
	* 取指令产生存储器读总线操作，读取内容是指令代码
	* 以存储单元为源操作数的指令引起存储器读总线操作，以存储单元为目的操作数的指令引起存储器写操作
	* CPU相应中断源时产生中断响应总线操作
	* ......
* 总线时序是指总线操作过程中总线上各信号在时间顺序上的配合关系。不同总线操作需要不同的总线时序予以配合
	* 存储器读时序、存储器写时序、中断响应时序......

#### 1、同步总线时序

* 总线上的数据传输由统一时标控制
* 时标通常由CPU的总线控制部件发出，送到总线上的所有部件；也可以由每个部件各自的时序发生器发出，但是必须由总线控制部件发出的时钟信号对它们进行同步
	* 优点：模块间的配合简单一致
	* 缺点：主从模块之间的时间配合属强制性同步，必须按速度最慢的部件来设计公共时钟

* 示例

	* 例1：写命令，其传输周期为：

		* T~1~：主模块发地址
		* T~1.5~：主模块提供数据
		* T~2~ ：主模块发写命令，从模块必须在规定时间内将数据写入地址总线所指明的单元中
		* T~4~：主模块撤销写命令和数据等信号

		<img src="/assets/images/总线和接口.assets/image-20200317004017775.png" alt="image-20200317004017775" style="zoom:50%;" />

	* 例2：读命令，其传输周期为：

		* T1：主模块发地址
		* T2：主模块发读命令
		* T3：从模块提供数据
		* T4：主模块撤销读命令

	<img src="/assets/images/总线和接口.assets/image-20200317004103275.png" alt="image-20200317004103275" style="zoom:50%;" />

	（同步总线要求“在规定的时间执行或完成规定的动作”，所有的操作都基于统一的时钟周期）

* STD总线的读存储器时序

	<img src="/assets/images/总线和接口.assets/image-20200317004153830.png" alt="image-20200317004153830" style="zoom:50%;" />

#### 2、异步总线时序

* 异步总线允许各模块速度的不一致性，提高了模块的适应性，给设计者带来更多的选择余地
* 异步总线中系统没有公用的时钟，主从模块之间通信时，采用应答方式进行联络和协调工作。根据问答信号之间的关系，异步总线时序可分成不互锁方式、半互锁方式和全互锁方式（又称握手方式），主设备在发数据的同时发选通信号STB (STroBe)，从设备收到数据后应答ACK (ACKnowledgement)；主从模块之间增加两条握手应答线

<img src="/assets/images/总线和接口.assets/image-20200317004253883.png" alt="image-20200317004253883" style="zoom:50%;" />

* **三种握手方式**

	* 不互锁方式
		* 主设备发STB，告诉从设备当前数据有效。间隔固定时间后，认为从设备已经收到，撤销STB
		* 从设备收到数据后发ACK应答。间隔固定时间后，撤销ACK

	<img src="/assets/images/总线和接口.assets/image-20200317004338753.png" alt="image-20200317004338753" style="zoom:50%;" />

	* 半互锁方式

		* 主设备发STB后，等待从设备的ACK应答。只有收到ACK后才撤销STB
		* 从设备发ACK后，不等待主设备的应答。在间隔固定时间后，撤销ACK

		<img src="/assets/images/总线和接口.assets/image-20200317004458022.png" alt="image-20200317004458022" style="zoom:50%;" />

	* 全互锁方式（四边沿协议）

		* 主设备发STB后，等待从设备的ACK应答。只有收到ACK后才撤销STB
		* 从设备发ACK后，等待主设备的应答（撤销STB），然后才撤销ACK
		* 主从设备相互等待，传输可靠性最高

		<img src="/assets/images/总线和接口.assets/image-20200317004551293.png" alt="image-20200317004551293" style="zoom:50%;" />

**关于同步和异步通信方式的讨论**

* 传输速度
	* 同步：如果从设备太慢，就无法满足时序要求
	* 异步：应答过程的交互次数越多，速度越慢
* 可靠性
	* 最可靠的方式：异步全互锁，每步操作“环环相扣”
* 兼顾传输速度和通信的可靠性
	* 互锁方式应配合使用等待超时处理机制

#### 3、半同步总线时序

* 半同步总线是对同步总线的一种优化，对于大多数速度较快的传送对象，均按照同步方式定时

	* 例如，主存储器的速度太慢，可插入一个时钟周期的办法让CPU等待存储器准备数据

* 对于系统所连接的少数速度较慢的设备，增加一条Ready/wait状态信号线，当慢速设备被访问时，可以利用这条信号线请求主模块延长传送周期

	* 例如：8086/8088 采用的就是半同步总线。当检测到READY信号线被拉低，则在T3/T4之间插入Tw

* 半同步总线提高了系统的适应性，但是速度仍然偏低

* 示例：

	* WAIT#信号表示需要进行等待，低电平有效。WAIT#信号持续1个时钟周期，则CPU读数据的时间滞后一个时钟周期
	* 插入等待时钟周期的数目可以根据存储器访问速度来确定，如果存储器访问速度低于两个时钟周期，那么就需要插入两个等待时钟周期（WAIT#信号持续两个时钟周期）

	<img src="/assets/images/总线和接口.assets/image-20200317004823950.png" alt="image-20200317004823950" style="zoom:50%;" />

#### 4、周期分裂式时序

* 在上述各种传输过程中，占用总线使用权的主设备以及被其选中的从设备，无论是否进行数据传输，始终占据着总线资源
* 若对读命令过程的进一步分析：在读命令传输周期中，除了申请总线这一阶段外，其余时间主要被用于如下三个方面的开销
	* 主模块通过总线向从模块发送地址和命令
	* 从模块按照命令进行读数据的必要准备
	* 从模块经总线向主模块提供数据
* 分离式总线的思想：将一个传输周期（或总线周期）分解为两个子周期（或者称为子阶段）
	* 在第一个子周期（寻址子周期，或称为地址阶段）中，主模块A获得总线使用权后，将命令、地址、A模块编号等信息发到系统总线上，由相关的从模块B接收下来。然后A模块放弃总线，供其它模块使用
	* 在第二个子周期（数据传输子周期，或称为数据阶段）中，B模块根据所收到的命令，经过一系列的内部操作，将A模块所需的数据准备好，然后由B模块申请总线使用权，一旦获准，B模块将A模块的编号和所需数据、B模块的地址等信息送到总线上，供A模块接收
* 将一个总线读周期或写周期分解为两个分离的子周期：寻址子周期、数据传送子周期
	* 在一些资料中，也把上述寻址子周期称作地址阶段，把数据传送子周期称作数据阶段
* 分裂式操作的技巧是总线设计中的一种重要思路
	* 将一个耗时长的操作分成几个耗时短的操作也是流水线设计的基本思想
	* 一些资料中，常把周期分裂式操作称作“分离式操作”、“流水线分离”等

## 二、片内总线AMBA

### (一) AMBA总线概述

#### 1、简介

* AMBA（Advanced Microcontroller Bus Architecture）总线是ARM公司研发的一种片上总线（on-chip bus）标准
* AMBA设计独立于处理器和芯片制造工艺
* AMBA拥有众多第三方支持
	* AMBA2已具备相对完整的功能
	* AMBA3侧重引入高性能的功能支持
	* AMBA4/AMBA5针对多CPU核环境做相应的优化

#### 2、AMBA定义了三种不同的总线

* 高级高性能总线AHB（Advanced High-performance Bus)
* 高级系统总线ASB（Advanced System Bus）
* 高级外设总线APB（Advanced Peripheral Bus）

| AMBA AHB                                                     | AMBA ASB                           | AMBA APB                                                  |
| ------------------------------------------------------------ | ---------------------------------- | --------------------------------------------------------- |
| 高性能<br>流水线（pipelined）操作<br/>多总线主机（multiplebusmasters）<br/>突发传输（bursttransfers）<br/>分裂式操作（splittransactions） | 高性能<br>流水线操作<br>多总线主机 | 低功耗<br/>地址锁存和控制<br/>接口简单<br/>适合大多数外设 |

#### 3、基于AMBA总线的系统

* AHB、ASB、APB
	* 以AHB或ASB作为高性能系统中枢总线，支持CPU、片上存储器、外部存储器和DMA设备间的数据传输
	* 用桥接器以连接低带宽的APB，外设挂接在APB上

<img src="/assets/images/总线和接口.assets/image-20200317005611339.png" alt="image-20200317005611339" style="zoom:50%;" />

### (二) AHB总线

#### 1、AHB系统的构成

##### (1) AHB系统要素

* AHB主机（Master）
	* 即总线的主控模块。总线主机能够通过提供地址和控制信息发起读写操作。任何时候只允许一个总线主机处于有效状态并能使用总线
* AHB从机（Slave）
	* 即总线的从属模块。从机在给定的地址空间范围内响应主机发起的读写操作。从机将成功、失败或等待的信号返回给有效的主机
* AHB仲裁器（Arbiter）
	* 确保每次只有一个总线主机被允许发起数据传输。AHB要求即便在单总线主机系统中也要实现仲裁器，且所有系统中只有一个仲裁器
* AHB译码器（Decoder）
	* AHB译码器用来对每次传输进行地址译码，从而为从机提供选择信号。AHB要求实现中集中式的译码器（centralized decoder）

##### (2) 基于多路选择器的AHB总线互联

<img src="/assets/images/总线和接口.assets/image-20200317082522016.png" alt="image-20200317082522016" style="zoom: 67%;" />

* 地址和控制选择器负责将主机发出的地址和控制信号连接至从机
* 数据选择器负责主机和从机之间的数据信号连接
* 仲裁器在不同的总线主机之间进行总线使用权仲裁，并决定当前得到授权的主机能将它的地址和控制信号连通到哪个从机
* 译码器控制读数据选择器，读数据选择器负责将从机信号连接到对应的主机上

##### (3) AHB特点概述

* 支持突发传输（burst transfer）
	* 启动一次AHB传输可以连续传输一个数据块
* 支持分裂式操作（split transactions）
	* 寻址和数据传输子周期分离
* 单周期总线主机移交（single cycle bus master handover）
	* 主机在时钟上升沿发出总线使用请求，仲裁器在时钟下降沿采样获得该请求，随即在下一个时钟上升沿更新总线允许信号。即，仲裁器在每个时钟周期都更新总线允许信号
* 单一时钟沿操作（single clock edge operation）
	* 所有信号变化均发生在时钟上升沿，这利于芯片内集成更多的多电路单元
* 非三态的实现（non-tristate implementation）
	* AMBA允许信号线以三态或非三态的形式实现，如，数据线为三态实现时可为双向传输线，非三态实现的时候读数据和写数据是两套独立的传输线
* 可扩展至更宽的数据总线架构(64位或128位)

#### 2、AHB信号定义

##### (1) AMBA中信号名称的前缀规则

| 前缀 | 含义及示例                                                 |
| ---- | ---------------------------------------------------------- |
| T    | 测试信号（与总线类型无关）                                 |
| H    | AHB信号，如HREADY是表示AHB的数据传输完毕的信号，高电平有效 |
| A    | ASB信号，主机与仲裁器之间的单向信号                        |
| B    | ASB信号，如BRESn为ASB复位信号，低电平有效                  |
| D    | ASB信号，单向的ASB译码信号                                 |
| P    | APB信号，如PCLK表示APB使用的主时钟                         |

所有信号名均为大写字母，信号若为低电平有效，则信号名称的最后加小写字母n

##### (2) AMBA2中AHB的信号

| 信号名称                    | 信号来源   | 用途说明                                                     |
| --------------------------- | ---------- | ------------------------------------------------------------ |
| HCLK<br>总线时钟            | 时钟源     | 为所有总线传输提供时基，所有信号时序都与HCLK的上升沿相关     |
| HRESTn<br/>复位             | 复位控制器 | 总线复位信号，用于复位系统和总线，低电平有效                 |
| HADDR[31:0]<br/>地址总线    | 主机       | 32位系统地址总线                                             |
| HTRANS[1:0]<br/>传输类型    | 主机       | 主机表示当前传输的类型，可以是不连续、连续、空闲和忙（NONSEQUENTIAL,SEQUENTIAL,IDLE,BUSY） |
| HWRITE<br/>传输方向         | 主机       | 高电平时表示一个写传输，低电平时表示读传输                   |
| HSIZE[2:0]<br/>传输大小     | 主机       | 表示传输的大小，可以是字节(8位)、半字(16位)或字(32位)等，协议允许的最大传输大小是1024位 |
| HBURST[2:0]<br/>突发类型    | 主机       | 表示传输是否组成了突发的一部分。支持4个、8个或16个节拍的突发传输，突发传输可以是增量或回环的 |
| HPROT[3:0]<br/>保护控制     | 主机       | 提供总线访问的附加信息，指示当前传输的安全保护级别           |
| HWDATA[31:0]<br/>写数据总线 | 主机       | 用来在写操作期间，从主机到从机传输数据。建议最小数据宽度为32位，在高带宽运行时可扩展 |
| HSELx<br/>从机选择          | 译码器     | 每个AHB从机都有自己独立的从机选择信号，并且用该信号来表示当前传输是否打算送给选中的从机。该信号是地址总线的组合译码 |
| HRDATA[31:0]<br/>读数据总线 | 从机       | 用来在读操作期间，由从机向主机传输数据。协议允许的数据宽度为：8、16、32、64、128、256、512、1024位 |
| HREADY<br/>传输完成         | 从机       | 当该信号为高电平时，表示总线上的传输已经完成。在扩展传输时该信号可能会被拉低 |
| HRESP[1:0]<br/>传输响应     | 从机       | 给传输状态提供了附加信息，提供四种不同的响应：OKAY、ERROR、RETRY和SPLIT |

##### (3) AMBA2中AHB的仲裁信号

| 信号名称                         | 信号来源               | 用途说明                                                     |
| -------------------------------- | ---------------------- | ------------------------------------------------------------ |
| HBUSREQx<br/>总线请求            | 主机                   | 从总线主机x传向总线仲裁器，用来表示该主机请求(控制)总线的信号。系统中每个总线主机都有一个HBUSREQx信号，最多16个总线主机 |
| HLOCKx<br/>锁定的传输            | 主机                   | 当该信号为高时，表示主机请求锁定对总线的访问，并且在该信号为低之前，其他主机不应该被允许授予总线 |
| HGRANTx<br/>总线授予             | 仲裁器                 | 该信号用来表示总线主机x目前是优先级最高的主机。当HREADY为高电平时，传输结束，地址控制信号的所有权发生改变。所以主机应在HREADY和HGRANTx都为高电平时，获得对总线的访问 |
| HMASTER[3:0]<br/>主机号          | 仲裁器                 | 表示哪个总线主机正在执行传输，被支持突发传输的从机用来确定哪个主机正在尝试一次访问 |
| HMASTLOCK<br/>锁定顺序           | 仲裁器                 | 表示当前主机正在执行一个锁定序列（sequence）的传输。该信号与HMASTER信号有相同时序 |
| HSPLITx[15:0]<br/>分离式传输请求 | 从机（支持分裂式操作） | 指示仲裁器，总线主机被允许重试一个分裂式操作（splittransaction）。每位对应一个总线主机 |

信号后缀x表示模块x。如，HBUSREQx可能分别表示HBUSREQarm或HBUSREQdma

#### 3、AHB的数据传输过程及“流水线”

##### (1) AHB的数据传输过程

* 两个阶段：地址阶段、数据阶段

<img src="/assets/images/总线和接口.assets/image-20200317083811390.png" alt="image-20200317083811390" style="zoom:50%;" />

##### (2) AHB的“流水线”机制

* 地址信息和数据信息交叠（overlapping）的操作方式，被称作流水线机制（pipeline）

<img src="/assets/images/总线和接口.assets/image-20200317083912673.png" alt="image-20200317083912673" style="zoom:50%;" />

* “流水线”分离

	* 2级流水线
		* 第n次传输的地址在第n-1次传输时被驱动到了地址总线上。“驱动地址”和“驱动数据”两个操作构成2级流水线操作
		* 从机因某种原因不能及时响应时，这个流水线就会被打断
	* “SPLIT”思想（即周期分裂式时序）
		* 周期分裂式时序：地址阶段和数据阶段可以被分离
		* 从机不能及时响应时，发送控制信号HSPLITx通知仲裁器
		* 仲裁器检测到HSPLITx后，知道从机当前不进行传输，则可以把总线的使用权出让给其他主机
		* 当从机做好接收数据准备后，通过控制信号HSPLITx发出重新启动传输的信号，仲裁器根据挂起操作主机的优先级决定何时再次分配总线使用权
		* 当主机获得总线使用权后，重新发送地址、控制等信息，继续刚才挂起的传输操作

* 插入等待周期的数据传输

	* 半同步式时序：若从机在数据阶段的第一个时钟周期没能准备好，则需要把HREADY拉为低电平，从而插入了等待周期

	<img src="/assets/images/总线和接口.assets/image-20200317084057056.png" alt="image-20200317084057056" style="zoom: 50%;" />

	* ​	例：三次AHB传输分别需要传输的是地址A、地址B和地址C对应的数据
		* 传输数据（其地址为B）的时候插入了一个等待周期
		* 对应地，地址总线上地址C也被扩展了

	<img src="/assets/images/总线和接口.assets/image-20200317084200659.png" alt="image-20200317084200659" style="zoom:67%;" />

#### 4、AHB的突发传输

##### (1) 突发传输

* 突发传输就是一次传输过程传输一个数据块而不是单个数据。既然是传输一个数据块，就涉及到数据块的长度，数据块的地址递增方式等
* 用突发传输类型信号HBURST[2:0]标识
	* HBURST[2:0]=000，SINGLE，单次传输
	* HBURST[2:0]=001，INCR
		* 未标识长度的地址递增式传输
		* Incrementing burst of unspecified length
	* HBURST[2:0]=010，WRAP4
		* 突发长度为4的地址循环递增式传输
		* 4-beat wrapping burst
	* 还有INCR8、WRAP8、INCR16、WRAP16

##### (2) 突发传输的状态

HTRANS[1:0]用来向从机指示突发传输过程中的不同状态，因而从机可知自身下一步的操作提示

| HTRANS | 状态   | 状态含义描述                                                 |
| ------ | ------ | ------------------------------------------------------------ |
| 00     | IDLE   | 指示当前周期没有数据需要传输，当主机被授权使用总线，但是不需要传输时使用该状态 |
| 01     | BUSY   | 指示主机正在进行突发传输，但是下一次数据传输不会马上发生。地址和控制信号线上的信号对应下一次即将发生的传输 |
| 10     | NONSEQ | NONSEQUENTIAL，指示当前传输是一次突发传输过程或单次传输的第一次传输。地址和控制信号线上的信号与前一次传输无关 |
| 11     | SEQ    | SEQUENTIAL，一次突发传输过程中非第一次的传输。地址和信号线上的信号对应上一个刚完成的传输 |

##### (3) WRAP4突发传输时序

WRAP4，拟传输数据的地址在16字节的边界处发生回转，0x38、0x3C →0x30、0x34

<img src="/assets/images/总线和接口.assets/image-20200317084551905.png" alt="image-20200317084551905" style="zoom:67%;" />

##### (4) INCR4突发时序

INCR4，4个传输数据的地址变化是递增的，没有在16字节边界处发生回转

<img src="/assets/images/总线和接口.assets/image-20200317084633188.png" alt="image-20200317084633188" style="zoom: 67%;" />

#### 5、AHB的译码

##### (1) 地址译码和从机选择信号

* AHB总线通过一组多路选择器实现主、从设备的互连。使用一个中央地址译码器提供从机选择信号HSELx

<img src="/assets/images/总线和接口.assets/image-20200317084717337.png" alt="image-20200317084717337" style="zoom: 67%;" />

##### (2) 总线允许信号与主机号的生成

* 由于采用集中式的译码器，每个主机在需要的时候随即驱动自身的地址信号，无须等待总线允许信号HGRANTx
* 集中式的译码器根据各个主机的总线使用请求产生总线允许信号HGRANTx，并在仲裁器的控制下生成主机号HMASTER[3: 0]，指示地址和控制多路选择器把主机的地址总线与对应从机的地址总线连接

<img src="/assets/images/总线和接口.assets/image-20200317084818251.png" alt="image-20200317084818251" style="zoom:67%;" />

#### 6、AHB的仲裁

##### (1) AMBA2中AHB的仲裁器接口信号

<img src="/assets/images/总线和接口.assets/image-20200317085016565.png" alt="image-20200317085016565" style="zoom: 50%;" />

信号后缀x表示模块x，每个总线主机都有一个HBUSREQx信号，最多支持16个总线主机

##### (2) 无等待状态的仲裁授予

* 主机通过HBUSREQ信号请求对总线的使用需求
* 仲裁器通过HGRANT信号指示主机x获得了总线使用权
* 仲裁器通过HMASTER指示当前获得总线使用权的主机号

<img src="/assets/images/总线和接口.assets/image-20200317085128471.png" alt="image-20200317085128471" style="zoom:67%;" />

时序示例：从机处于准备好的状态（HREADY指示准备好）

##### (3) 有等待状态的仲裁授予

* 从机通过HREADY信号指示是否就绪
* 主机在HREADY有效时才发送地址

<img src="/assets/images/总线和接口.assets/image-20200317085252818.png" alt="image-20200317085252818" style="zoom:67%;" />

时序示例：从机拉低HREADY，指示未准备好

##### (4) 总线控制权在两个主机之间的移交

* 数据总线的控制权滞后于地址总线
* 主机#2控制地址总线的时候，主机#1仍在控制数据总线

<img src="/assets/images/总线和接口.assets/image-20200317085413908.png" alt="image-20200317085413908" style="zoom:67%;" />

##### (5) 突发传输后的总线移交

* 总线控制权移交发生在一次突发传输的末尾
* 仲裁器在倒数第二个地址被采样后改变总线允许信号HGRANTx。新的总线允许信号HGRANTx将与最后一个地址在相同的时刻被采样

<img src="/assets/images/总线和接口.assets/image-20200317085505950.png" alt="image-20200317085505950" style="zoom:67%;" />

#### 7、AHB主机接口及时序参数

##### (1) AHB主机接口

* 主机在HREADY和HGRANTx都为高电平时，获得对总线的访问
* 主机x通过HBUSREQx向总线仲裁器请求使用总线，通过HLOCKx告知其他主机不应该被允许授予总线

<img src="/assets/images/总线和接口.assets/image-20200317085555931.png" alt="image-20200317085555931" style="zoom:67%;" />

##### (2) AHB从机接口

* HMASTER[3:0]、HMASTLOCK、HSPLIT[15:0] 信号
* 用于支持名为“SPLIT”的传输模式（在ARM公司的资料中，被称作分裂式操作，Split transactions；其他一些资料中也称作流水线分离）

<img src="/assets/images/总线和接口.assets/image-20200317085651013.png" alt="image-20200317085651013" style="zoom:67%;" />

#### 8、AHB从机接口及流水线“分离”

**”SPLIT“传输**

* “SPLIT”传输，指前述AHB传输地址阶段和数据阶段可以分离
* “流水线”机制：前一次AHB传输的数据实际上实在下一次AHB传输的一开始才被读取的，第n次AHB传输的地址则是在第n-1次AHB传输的时候就已经被驱动到了地址总线上。这样“驱动地址”和“驱动数据”两个操作构成了2级流水线操作
* 从机因某种原因不能及时响应时，流水线就会被打断，从而影响到总体性能。SPLIT方式的数据传输就是为了应对这种情形。从机在不能及时准备好数据时，HSPLITx[15:0]发出启动SPLIT传输的信号。仲裁器检测到HSPLITx后，知道从机当前不进行传输，则可以把总线的使用权出让给其他主机
* 当从机做好接收数据准备后，通过HSPLITx[15:0]发出重新启动传输的信号，仲裁器许可后继续刚才挂起的传输操作

### (三) ASB总线

### (四) APB总线

### (五) AXI总线

* 从设计思想上看，ASB、APB可视为AHB功能的一个子集；AXI可视为AHB的升级版本；AXI之后的其他版本针对高性能、智能手机等不同场景改进设计
* AHB总线分离了一个总线周期的地址阶段和数据阶段，更便于实现在现代总线中常用的Pipelining和Split技术
* AXI总线则进一步分离了总线的通道，将AHB的单通道分解为5个独立的通道：读地址通道（Read Address）、读数据通道（Read Data）、写地址（Write Address）通道、写数据（Write Data）通道、写响应（Write Response）通道，进一步加速了对存储器的读写访问
* AXI、AHB、APB的对比

| 总线     | AXI                                                          | AHB                                                          | APB                                                          |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 总线宽度 | 8，16，...，1024                                             | 32，64，128，256                                             | 8，16，32                                                    |
| 地址宽度 | 32                                                           | 32                                                           | 32                                                           |
| 通道特性 | 读写地址通道<br/>读写通道均独立                              | 读写地址通道共用<br/>读写数据通道独立                        | 读写地址通道共用<br/>读写数据通道独立<br/>不支持读写并行操作 |
| 体系结构 | 多主/从设备<br/>仲裁机制                                     | 多主/从设备<br/>仲裁机制                                     | 单主设备（桥）/多从设备<br/>无仲裁                           |
| 数据协议 | 支持流水线<br/>支持分裂式操作<br/>支持突发传输<br/>支持乱序访问<br/>字节/半字/字<br/>大小端对齐<br/>非对齐操作 | 支持流水线<br/>支持分裂式操作<br/>支持突发传输<br/>支持乱序访问<br/>字节/半字/字<br/>大小端对齐<br/>不支持非对齐操作 | 一次读/写传输占两个时钟周期<br/>不支持突发传输               |
| 传输方式 | 支持读写并行操作                                             | 支持读写并行操作                                             | 不支持读写并行操作                                           |
| 时序     | 同步                                                         | 同步                                                         | 同步                                                         |
| 互联     | 多路                                                         | 多路                                                         | 无定义                                                       |

### (六) AMBA的不同版本

<img src="/assets/images/总线和接口.assets/image-20200317090653896.png" alt="image-20200317090653896" style="zoom:67%;" />

## 三、系统总线/外部总线

### (一) PCI

#### 1、PCI总线

* PCI（Peripheral Component Interconnect）外部设备互连总线，是一种高性能的局部总线
* PCI的相关工作始于1900年，最早由Intel的IAL实验室（Intel's Architecture Development Lab）提出，并率先在IBM的兼容PC上得到应用，后来又得到Compaq、HP和DEC等多家计算机公司的响应，并成立了PCI特别兴趣工作组（PCI Special Interest Group，PCI-SIG）

#### 2、PCI应用现状

* 早期PC使用8 位的XT 总线作为局部总线，后来升级到16 位的ISA(Industry Standard Architecture)总线，并逐步发展到32 位的EISA(Extended Industry Standard Architecture)、VESA(Video Electronics Standards Association)和MCA(Micro Channel Architecture)总线
* PCI局部总线是一种具有多路地址线和数据线的高性能32/64位总线。PCI推出后迅速淘汰了EISA、VESA 等其他32 位总线
* 在PC领域，PCI已经逐渐被更高性能的PCI Express总线替代，但在嵌入式领域PCI总线依然应用广泛，且其性能足够满足绝大多数嵌入式系统的需求

#### 3、PCI→PCI-X

* 最初的PCI标准中总线时钟（总线频率）为33MHz，数据线宽度为32位，可扩充到64位，所以数据传输率可达132MB/s～264MB/s。后期的PCI版本64位并行数据传送，总线时钟支持33/66MHz，能够达到最高528MB/s的数据传输速率
* 在PCI 的基础上，进一步提出PCI-X 规范。PCI-X 533峰值速率是4.2GB/s

#### 4、PCI总线结构

* PCI总线中有三类设备：PCI主设备、PCI从设备和桥设备
* PCI总线在高速处理器与其他低速设备之间架起了一座“桥梁”。使计算机结构成为基于PCI总线的三级总线结构
* PCI总线是一种树型结构，PCI总线上可以挂接PCI设备和PCI桥片，PCI总线上只允许有一个PCI主设备，其他的均为PCI从设备，而且读写操作只能在主从设备之间进行，从设备之间的数据交换需要通过主设备中转

<img src="/assets/images/总线和接口.assets/image-20200317091040079.png" alt="image-20200317091040079" style="zoom:67%;" />

#### 5、PCI系统框图

* \#0总线挂接了主存储器、辅助存储器、多媒体设备等不同外设
* #1总线通过PCI-to-PCI桥设备挂接到#0总线

<img src="/assets/images/总线和接口.assets/image-20200317091141097.png" alt="image-20200317091141097" style="zoom:67%;" />

### (二) PCI Express

#### 1、PCI Express（简称PCI-E或PCIe）

* PCI Express (Peripheral Component Interconnect Express)
* 2001年春，英特尔公司提出用新一代的技术取代PCI总线和多种芯片的内部连接，称之为第三代I/O总线
* 2001年底，包括Intel、AMD、DELL、IBM在内的20多家业界主导公司开始起草新技术的规范，并在2002年完成，对其正式命名为PCI Express。
* 标准由PCI特别兴趣工作组（PCI Special Interest Group，PCI-SIG）维护和升级
* 相比于PCI，PCI-E最大的改变是由并行改为串行，使用差分信号传输（differential transmission）

#### 2、PCI-E的通道

* 两个设备间的一条PCI-E链路（link）可包含1至32个通道（lane）。习惯上用X1、X4、X8、X16、X32等方式表示链路所包含的通道数目，也称为PCI-E的“宽度”或“位宽”
* 单个通道（lane）包含两对差分传输信号线，一对用于接收数据，另一对用于发送数据。故每个通道共4根信号线（wire）
* 逻辑上看，每个通道就是一条双向的比特流传输通路

<img src="/assets/images/总线和接口.assets/image-20200317091330632.png" alt="image-20200317091330632" style="zoom: 67%;" />

#### 3、目前高速接口均为串行标准

* ATA(IDE) → SATA (Serial ATA)
* SCSI → SAS (Serial Attached SCSI)
* ISA → PCI → PCI-Express

并行数据线多时，CLK不能高

#### 4、PCI-E点对点串行连接拓扑结构

* PCI Express总线是一种点对点串行连接的设备连接方式，各个设备之间并发的数据传输互不影响。PCIe系统包括Root complex、Switch、PCIebrige、Endpoint四大类设备
	* Rootcomplex（根复合体）是处理器与PCIe总线的接口，通常由CPU集成
	* Switch（交换器），允许多个设备连接到一个PCIe端口，用于扩展PCIe总线，具有路由功能
	* PCIe桥，负责PCIe和其他总线转换连接，如连接PCI、PCI-X甚至是另外一条PCIe总线
	* Endpoint（端点设备），即PCIe接口的各种设备，分为标准PCIe端点和传统端点（LegacyEndpoint）

<img src="/assets/images/总线和接口.assets/image-20200317091744624.png" alt="image-20200317091744624" style="zoom:67%;" />

#### 5、PCI-E不同版本的传输速率

<img src="/assets/images/总线和接口.assets/image-20200317091834106.png" alt="image-20200317091834106" style="zoom:50%;" />

* 表中“8b/10b编码”意为将8比特编码为10比特
* 表中“GT/s”表示“gigatransfersper second”，2.5 GT/s对应每秒钟每通道传输2500M比特，若采用8b/10b编码，实际每秒钟每通道能传输的业务比特是2500M*8/10=2000M (bits)=250M (Bytes)

### (三) USB

#### 1、USB

* USB(universal serial bus)，通用串行总线，是一种外部总线标准。用于规范电脑与外部设备的连接和通讯，是应用在PC领域的接口技术。USB接口支持设备的即插即用和热插拔功能。USB是在1994年底由由Compaq、Digital、BM、Intel，Microsoft、NEC和NothernTelecom7家公司联合提出的
* 在USB1.0/USB2.0中，“D+”和“D-”组成一对差分信号线用于数据传输，VBUS和GND对应5V电源和地。USB3.0后，又增加了两对差分信号线以提供更高速的数据传输

<img src="/assets/images/总线和接口.assets/image-20200317091944549.png" alt="image-20200317091944549" style="zoom:50%;" />

#### 2、USB的机械接口

<img src="/assets/images/总线和接口.assets/image-20200317092004988.png" alt="image-20200317092004988" style="zoom:50%;" />

#### 3、USB的不同版本

![image-20200317092053370](/assets/images/总线和接口.assets/image-20200317092053370.png)

### (四) 典型的计算机总线系统

#### 1、以8051为核心的嵌入式控制器的总线

<img src="/assets/images/总线和接口.assets/image-20200317092222337.png" alt="image-20200317092222337"  />

* 8051是一种八位单芯片微控制器，属于MCS-51单芯片的一种，由Intel于1981年设计

#### 2、以Cortex-M3为核心的嵌入式控制器的总线

![image-20200317092344574](/assets/images/总线和接口.assets/image-20200317092344574.png)

#### 3、基于8086的初期PC系统总线

![image-20200317092415603](/assets/images/总线和接口.assets/image-20200317092415603.png)

* 全球第一款16位通用微处理器芯片，诞生于1978年
* Intel在二十世纪70年代设计了8086微处理器，是x86架构处理器的鼻祖。8086有16根数据线和20根地址线（其中16根是与数据线复用的）
* 8086系统为简单的单总线结构

#### 4、x86架构PC基于前端总线的多总线结构

![image-20200317092517985](/assets/images/总线和接口.assets/image-20200317092517985.png)

* CPU通过前端总线FSB（F ro n tSideBus）与存储器和外设进行数据交互，计算机主板上的北桥（Northbridge）芯片负责联系内存、显卡等数据吞吐量最大的部件，并和南桥芯片（S o u t hbridge）连接。CPU就是通过前端总线FSB连接到北桥芯片，进而通过北桥芯片和内存、显卡交换数据

#### 5、如今x86架构PC的PCH控制总线结构

![image-20200317092555682](/assets/images/总线和接口.assets/image-20200317092555682.png)

* 2009年，Intel推出的单芯片设计的南北桥芯片整合方案。这颗主控芯片既不叫北桥，也不叫南桥，而是称作“Platform Controller Hub”芯片。PCH主要负责PCI-E和I/O设备的管理，它实际上仅提供南桥的功能（此时处理器已经整合北桥功能）

#### 6、第十代智能英特尔® 酷睿™

![image-20200317093735865](/assets/images/总线和接口.assets/image-20200317093735865.png)

* 2019年Intel发布的第十代智能英特尔® 酷睿™ 移动式处理器，添加了一些新的接口标准，如雷电接口、USB3.1、SATA3.0。
* PCH已经不再是一颗单独封装的芯片，而是和CPU一起被封装在一起

## 四、输入/输出接口

**采用I/O接口的必要性：**

* CPU与存储器交换信息——数据格式和存取速度基本匹配
* CPU与外设交换信息——由于外设的多样性
	* 速度有较大差异
	* 信号电平不一致
	* 数据格式不同
	* 时序不匹配
* 因此CPU必须经过中间电路再与外设相连，这部分电路被称为I/O接口电路
* PC机系统板的可编程接口芯片、I/O总线槽的电路板、适配器/连接器都是接口电路

### (一) 输入/输出接口概述

#### 1、I/O接口的功能

* 设置数据缓冲解决速度不匹配问题
	* 事先把要传送的数据准备好，在需要的时刻完成传送。经常使用锁存器和缓冲器，并配以适当的联络信号来实现这种功能
* 设置电平转换电路解决电平不一致问题
	* 如计算机和外设之间串行通信时，必须采用（线路）驱动器进行电平转换
* 设置信息转换逻辑满足各自格式要求
	* 将外设传送的模拟量，经A/D转换成数字量，送到计算机去处理。计算机送出的数字信号经D/A转换成模拟信号，驱动某些外设工作
* 设置时序控制电路同步CPU和外设的工作
	* 接口电路接收CPU送来的命令或控制信号、定时信号，实施对外设的控制与管理，外设的工作状态和应答信号也通过接口及时返回CPU，以握手联络(handshaking)信号来保证主机和外部I/O操作实现同步
* 提供地址译码电路
	* 计算机中存在多个外设，每个外设需要与CPU交换几种信息，因此接口电路中常含若干端口，其I/O地址由接口电路中的地址译码电路提供
* 提供I/O控制、读/写控制及中断控制等逻辑

#### 2、I/O接口的分类

##### (1) 按数据传输方式

* 可分为串行接口、并行接口
	* 并行接口是指微处理器与I/O接口之间、I/O接口与外部设备之间均以多个比特位的并行方式送数据
	* 串行方式是指接口与外设之间采用单个比特位串行方式传送数据
* 串行接口、并行接口对比
	* 并行接口适用于传输距离较近、传输速度较高的场合，接口电路相对简单
	* 串行接口则适用于传输距离较远、传输速度相对较低的场合，传输线路成本较低，接口电路相对前者更复杂

##### (2) 按时序控制方式分类

可分为同步、异步

* 同步接口是指数据传输由统一的时钟信号同步控制，这个时钟信号为发送放和接收方共有

<img src="/assets/images/总线和接口.assets/image-20200317094824416.png" alt="image-20200317094824416" style="zoom:50%;" />

* 异步接口上的数据传送则采用异步应答的方式进行，不依赖于统一的时钟

<img src="/assets/images/总线和接口.assets/image-20200317094839760.png" alt="image-20200317094839760" style="zoom:50%;" />

##### (3) 按主机访问I/O设备的控制方式分类

* 可分为程序查询接口、中断接口、直接存储器访问（DMA）接口

##### (4) 其他分类

* 如按数据流程方向可分为单工、半双工、全双工接口

<img src="/assets/images/总线和接口.assets/image-20200317094931136.png" alt="image-20200317094931136" style="zoom:50%;" />

#### 3、I/O接口规范的常规内容

* 接口设计的目的是为了协调上述微处理器与外设之间的不一致，用来实现速率匹配、缓冲、数据格式的转换和电平的转换等功能
* 依据不同外设的特点，形成了很多典型的接口设计，这些全球通用的接口设计方案往往以工业界公认的规范（Specification）形式出现。
	* 存储接口SATA(Serial Advanced Technology Attachment)
	* 通用数据接口USB (Universal Serial Bus)
	* 视频接口DVI (Digital Video Interface)
	* 视频接口HDMI(High Definition Multimedia Interface)

##### (1) 输入/输出接口电路

* 输入/输出接口电路的功能隶属于通常意义的物理层功能。规定了为传输数据所需要的物理链路创建、维持、拆除，而提供具有机械的、电子的、功能的和规范的特性。
	* 机械特性，指明通信实体间硬件连接接口的机械特点。如接口所用接线器的形状和尺寸、引线数目和排列、固定装置等。
	* 电气特性，规定了在物理连接上，导线的电气连接及有关电路的特性。一般包括接口电缆的各条信号线上出现的电压的范围、信号的识别、最大传输速率的说明、发送器的输出阻抗、接收器的输入阻抗等电气参数。
	* 功能特性，指明物理接口各条信号线的用途，如某条信号线上出现的高低电压表示什么含义。如接口信号线分为数据线、控制线、地址线、时钟线和接地线等。
	* 规程特性，规定接口传输比特流的全过程，及不同传输事件发生的先后顺序，规定了物理连接建立、维持和交换信息时，收发双方在各自电路上的动作序列

##### (2) I/O接口标准的链路层功能

* 在一些输入/输出接口的标准定义中，除了物理层功能，也纳入了数据块格式、数据块检验方式等链路层功能（OSI模型的第二层）
* 例如，IBM的BSC（Binary Synchronous Communications）协议定义的传输数据格式如下图

<img src="/assets/images/总线和接口.assets/image-20200317095401648.png" alt="image-20200317095401648" style="zoom:67%;" />

#### 4、I/O接口的结构

##### (1) I/O端口

* I/O端口指I/O接口电路中的各类寄存器
* CPU与外设通信时，主要传送数据信息、状态信息和控制信息
* 在接口电路中，这些信息分别进入不同的寄存器，CPU也是通过地址对这些寄存器进行寻址。为了与内存单元及CPU内部寄存器相区别，通常将这些寄存器和它们的控制逻辑统称为I/O端口（Port）
* 在一般接口电路中都要设置以下几种端口：
	* 数据端口
	* 状态端口
	* 命令/控制端口
* 中断控制逻辑，负责中断请求信号的建立与撤销

##### (2) I/O接口中的三类端口（寄存器）

* 数据端口
	* 数据端口（Data Port）或数据口，用来存放CPU与外设需要交换的数据，长度一般为1~2字节。数据口主要起数据缓冲作用
* 状态端口
	* 状态端口（Status Port）或状态口，指示外设的当前状态。状态口通常具有以下几个常见的状态位，以反映外设的工作状态
	* 准备就绪位(Ready)
		* 对于输入端口，该位为1表明端口的数据寄存器已准备好数据，等待CPU来读取；当数据被取走后，该位清0
		* 对于输出端口，该位为1表明端口中的输出数据寄存器已空，可以接收下个数据；当新数据到达后，该位清0
	* 忙碌位(Busy)，表明输出设备是否能接受数据
		* 若该位为1，表示外设正在进行I/O传送操作，暂时不允许CPU送新的数据过来
		* 本次数据传送完毕，该位清0，表示外设已处于空闲状态，又允许CPU将下一个数据送到输出口
	* 错误位(Error) 
		* 如果在数据传送过程中产生了某种错误，可将错误状态位置1，以便CPU进行相应的处理
		* 系统中可以设置若干错误状态位，表明不同性质的错误，如奇偶校验错、溢出错等
* 命令端口
	* 也称为控制端口(Control Port)，用来存放CPU向接口发出的各种命令和控制字，控制接口或设备的动作
	* 常见的命令信息有启动、停止、允许中断等

<img src="/assets/images/总线和接口.assets/image-20200317095843625.png" alt="image-20200317095843625" style="zoom:67%;" />

读信号用以指示数据从I/O传输到CPU，写信号用以指示数据从CPU传输到I/O接口。高位地址生成片选信号，选择当前接口；低位地址连接外设片内地址线，选择内部端口

#### 5、I/O端口编址

##### (1) I/O端口的编址方法

* 为了让CPU能够访问这些I/O端口，每个I/O端口都需有自己的端口地址(或端口号)
* 在计算机系统中，如何编排这些I/O接口的端口地址，即所谓的I/O端口的编址方式
* 常见的I/O端口编址方式有两种
	* I/O端口和存储器统一编址，也称存储器映像的I/O（Memory Mapped I/O）方式
	* I/O端口和存储器分开单独编址，也称I/O映像的I/O（I/O Mapped I/O）方式

##### (2) Memory-Mapped I/O

* 系统中每个I/O端口都看作1个存储单元，并与存储单元统一编址，所有访存指令均可用来访问I/O端口，不用设置专门的I/O指令

* 存储器映像编址的地址空间分布情况如下图所示

	<img src="/assets/images/总线和接口.assets/image-20200317100050246.png" alt="image-20200317100050246" style="zoom:50%;" />

#### (3) I/O Mapped I/O

* 对系统中的I/O端口地址单独进行编址，不占用存储空间；使用专门的IN/OUT指令来访问I/O端口。
* 这种方式的地址空间分布如下：

<img src="/assets/images/总线和接口.assets/image-20200317100117813.png" alt="image-20200317100117813" style="zoom:50%;" />

##### (3) I/O端口两种地址映射方式对比

* I/O单独编址

	<img src="/assets/images/总线和接口.assets/image-20200317100326444.png" alt="image-20200317100326444" style="zoom:50%;" />

	* 优点：
		* I/O端口地址不占用存储器地址空间
		* I/O端口地址译码较简单，寻址速度较快
		* 使用专用I/O指令和存储器访问指令有明显区别，可使程序编制得清晰
	* 缺点：
		* 专用I/O指令类型少，远不如存储器访问指令丰富
		* CPU提供存储器读/写、I/O端口读/写两组控制信号

* 存储器映像编址

	<img src="/assets/images/总线和接口.assets/image-20200317100453333.png" alt="image-20200317100453333" style="zoom:50%;" />

	* 优点：
		* 对I/O口的操作与对存储器的操作完全相同，无须专用的I/O指令
		* 外设数目或I/O寄存器数目几乎不受指令限制
		* CPU读/写控制逻辑较简单
	* 缺点：
		* 占用了存储器的一部分地址空间
		* 增加了地址译码电路的复杂性

### (二) 输入/输出接口的数据传送方式

**I/O传送方式：**

* 主机与外围设备之间的数据传送控制方式（即I/O控制方式）包括：
	* 程序控制方式（软件），数据传送在程序控制下完成
		* 无条件传送：外设永远处于“准备好”的状态
		* 条件传送（查询传送）：只有外设状态许可才可访问
	* 中断方式（软件）
		* 外设发中断请求，CPU响应后完成数据传送
	* DMA方式（硬件）
		* DMA控制器临时接管CPU的地址、数据和控制总线，在存储器和I/O接口之间实现直接数据传送

#### 1、无条件传送方式

* 也称同步传送方式，主要用于对简单外设进行操作，所需的硬件和软件都较少

##### (1) 特点

* 需要输入时，总是认为输入设备处于准备好状态
* 需要输出时，总是认为输出设备处于准备好状态；无需对外设进行查询
* 需要输入或输出操作时，直接执行I/O输入输出指令，立即进行数据传送操作
* 此类接口在实现时，数据输入需要使用缓冲器；数据输出需要使用锁存器

##### (2) 无条件数据访问方式I/O接口电路

* 三态缓冲器作用
	* 外设数据保持时间相对于CPU的处理时间要长得多
	* 输入数据不能影响系统总线的正常使用
* 输出使用一个锁存器
	* CPU速度很快，而物理外设的速度比较慢，需要电路输出端保持数据

<img src="/assets/images/总线和接口.assets/image-20200317100927328.png" alt="image-20200317100927328" style="zoom:67%;" />

#### 2、查询传送方式

* 也称为异步查询传送方式
* 有一些外设，处理器访问时需要关心外设的状态，只有状态许可方可访问外设
	* 如，对A/D转换器的访问，只有模/数转换结束后，CPU才能读取转换的结果。又如，在使用串口外设进行数据通信时，只有串口发送缓冲区有空位置了，CPU才可以写入数据；同理，CPU接收数据的时候，也需要在接收缓冲区不空（有接收数据）时进行读取
	* CPU对此类外设进行输入或输出操作时需要考虑外设的状态，故此类外设的访问方式也称为条件传送方式
	* 值得注意的是，大多数外设都是条件访问方式

##### (1) 特点

* 输出：CPU对外设查询“BUSY？”，不忙才输出，否则继续查询
* 输入：CPU对外设查询“READY？”，准备好才读入，否则继续查询
* 接口特点：
	* 优点：避免了对端口的“盲读”、“盲写”，数据传送的可靠性高，并且硬件接口相对简单
	* 缺点：CPU工作效率低，I/O响应速度慢
* 对外设要求：提供状态口和数据口
* 在有多个外设的系统中，CPU的查询顺序由外设的优先级确定

##### (2) 查询流程

<img src="/assets/images/总线和接口.assets/image-20200317101154035.png" alt="image-20200317101154035" style="zoom:67%;" />

##### (3) 状态查询方式I/O接口电路

为了实现状态的查询，接口电路中既要有数据端口，又要有状态端口

<img src="/assets/images/总线和接口.assets/image-20200317101448299.png" alt="image-20200317101448299" style="zoom: 50%;" />

#### 3、中断传送方式

* 可将其归类为一种程序控制传送。中断方式具有如下一些优点：
	* 提高了CPU的工作效率
	* 外围设备具有申请服务的主动权
	* CPU可以和外设并行工作
	* 可适应实时系统对I/O处理的要求
* 采用中断方式后，仅在需要进行I/O传送时外设才向CPU发中断请求。CPU在中断服务程序中完成CPU和外设之间的数据交换

##### (1) 中断方式I/O接口电路

* 外部设备需要传输数据时，外设触发中断控制器的中断请求信号并由中断控制器把该信号送给CPU，CPU收到中断请求信号后，暂停当前程序的运行，而转去执行读/写接口数据的中断服务程序，实现CPU与外设的数据传输
* 在程序查询方式中，由于CPU对外部设备会执行大量状态查询的指令，CPU的利用率不高。如果CPU采取不断查询的方法，则长期处于“等待”状态，不能进行别的处理，也不能对其他事件做出响应。在程序中断传输方式下，I/O端口状态查询工作交给中断控制器去完成

<img src="/assets/images/总线和接口.assets/image-20200317101652505.png" alt="image-20200317101652505" style="zoom:67%;" />

##### (2) 中断的概念

**定义**

* 中断：由于某些事件计算机中止当前程序的运行，转去执行中断服务程序，中断服务程序完毕后，又返回继续运行正常程序
* 中断源：引起中断的原因

<img src="/assets/images/总线和接口.assets/image-20200317102009125.png" alt="image-20200317102009125" style="zoom:50%;" />

**中断源**

* 为了区分源自CPU的内、外的中断源，早期的资料中习惯上把来自CPU外部的外中断称作中断（Interrupt），而把来自CPU内部的内中断称作陷阱（Trap）
* 如今的微处理器芯片则习惯用异常处理（Exception Handling）机制来描述过去CPU设计中的中断技术
	* 如ARM的Cortex-m4的中断控制器（NVIC，Nested Vectored Interrupt Controller）处理芯片内所有的异常（Exception）
	* Cortex-m4定义的异常包括不可屏蔽中断（NMI）、中断（Interrupt）、内存管理错误（MemMangeFault）、总线错误（Bus Fault）、非法指令（Usage Fault）、系统定时器错误（SysTick）等

**典型计算机系统的中断源**

通常计算机系统的中断处理模块可以管理多个中断源并处理多种不同类型的中断。为了能够识别不同的中断源，会对中断源进行命名或编号，这个编号被称为中断类型码或中断类型号

<img src="/assets/images/总线和接口.assets/image-20200317102133928.png" alt="image-20200317102133928" style="zoom: 67%;" />

**中断向量**

* 中断向量即中断服务子程序的入口地址（或首地址）。即中断服务子程序的第一条指令在存储器中的存放地址。一般来说，每个中断源都有自身的中断名或中断向量，有自身对应的中断服务子程序
* 通常的处理器设计中，所有的中断服务子程序入口地址会集中存放在存储器的特定区域（如8086系统中是内存的最低1KB），特定的中断类型码对应这个区域中特定位置的中断矢量。这个特定的区域称为中断向量表（IVT，Interrupt Vector Table），通过中断向量表将中断类型码和中断向量关联起来
* 当中断发生的时候，系统根据中断类型码到中断向量表中获得中断向量的过程也被称做中断索引

**中断处理过程**

* 在计算机系统中，中断的整个过程分为：中断响应、中断处理和中断返回等三个阶段
* TF（Trap Flag）标志位IF（Interrupt Flag）标志位是CPU内部中断状态寄存器（或称中断标志寄存器）中的位
* TF=1表示产生了陷阱；IF=1表示产生了（外）中断

<img src="/assets/images/总线和接口.assets/image-20200317102354779.png" alt="image-20200317102354779" style="zoom: 80%;" />

**优先级、嵌套**

* 中断优先级
	* 中断请求有优先顺序之分。若同时出现多个中断请求，CPU按照事先规定的策略，响应优先级最高的中断请求
	* 对外设优先级的判断一般可以采用软件查询、硬件排序或采用专用芯片管理等方法来实现
* 中断嵌套
	* CPU正在执行中断服务程序时又有优先级更高的中断请求到达时，如果此时CPU允许中断，则CPU暂停当前中断服务程序，进入更高级的中断服务程序
* 中断屏蔽
	* CPU通过硬件电路和软件设置，对中断源产生的中断请求能否到达CPU的硬件引脚进行控制

##### (3) 中断优先级管理

**软件查询**

* 软件查询也需要使用少量硬件电路，当系统中有多种外部设备，将这些设备的中断请求信号相“或”，从而产生一个总的中断请求信号INTR发给CPU
* CPU读取中断请求寄存器后可获知有哪些中断，之后程序员所选择的处理顺序就体现了优先权

<img src="/assets/images/总线和接口.assets/image-20200317102644374.png" alt="image-20200317102644374" style="zoom: 67%;" />

**中断优先权编码电路**

* 任一外设对应的中断请求位和中断允许位同时为“1”时，即可产生中断请求信号。在两种情况下该中断请求信号能传送至INTR引脚：比较器输出为“1”时，中断请求信号可通过与门1送出；“优先权失效”信号为“1”时，中断请求信号可通过与门2送出
* 编码器每位输入线的有效电平都对应一个编码，在多位输入线有效时编码器只输出优先权最高的编码；优先权寄存器中记录的是CPU当前正在处理的中断的编码；比较器输出为“1”（即A>B）说明可以产生中断嵌套；“优先权失效”信号说明当前CPU没有处理任何中断，不需要再判断中断能否嵌套

<img src="/assets/images/总线和接口.assets/image-20200317103010108.png" alt="image-20200317103010108" style="zoom:67%;" />

**菊花链式优先权排队电路**

* 在每个中断源的接口电路中设置一个逻辑电路，组成一个链，叫菊花链
* CPU送出中断响应信号后，若设备1无中断请求，则与门A1关门，A2开门，中断响应信号继续向下一级传送；若设备2有中断请求，则与门B1开门，中断响应信号送至设备2，同时B2关门，中断响应信号不再向下传送。
* 设备接入菊花链的顺序就确定了设备的中断优先级别

<img src="/assets/images/总线和接口.assets/image-20200317103131780.png" alt="image-20200317103131780" style="zoom: 67%;" />

##### (4) 中断控制方式的接口电路

* 当外设准备好输入数据后发出选通信号，数据进入锁存器中，并同时将中断请求触发器置“1”。如果中断屏蔽触发器允许中断（Q1输出为“1”），与门被打开，因而可以产生中断请求信号INT

<img src="/assets/images/总线和接口.assets/image-20200317103255808.png" alt="image-20200317103255808" style="zoom:67%;" />

#### 4、直接存储器访问（DMA）方式

##### (1) 问题的提出

* 采用程序控制方式进行数据传送时，都是靠CPU执行指令实现数据的输入/输出。CPU先从“源”将数据读入到内部寄存器，再将内部寄存器的数据写到“目的”，因此存储器与I/O接口之间进行数据传送至少需要两个完整的总线周期
* 中断方式虽能较好地利用CPU资源，但是每次进入中断和退出中断的现场保护与恢复需较多的时间开销
* 对于高速外设（如磁盘或高速数据采集系统等），程序控制方式传送无法满足数据传输率的要求

##### (2) 基本思路

* DMA方式也要利用系统总线，平时总线由CPU管理，当外设需用DMA方式传送数据时，可请求CPU让出总线控制权，用专用硬件接口电路临时接管总线，在I/O接口与存储器之间直接进行数据传送
* 该电路在一个总线周期内能够同时发出内存单元和I/O端口的选择信号以及“读”信号和“写”信号，直接将“源”输出的数据写到“目的”中
* 以上方式称为直接存储器存取（Direct Memory Access），简称DMA方式。完成这一任务的硬件控制电路称为DMA控制器，简称DMAC

##### (3) DMA传送的形式

DMA又分为DMA写（I/O接口 → 内存）和DMA读（内存 → I/O接口）。下图是几种DMA传送形式的示意

<img src="/assets/images/总线和接口.assets/image-20200317103442120.png" alt="image-20200317103442120" style="zoom:67%;" />

##### (4) DMA传送的基本步骤

* DMAC向CPU发出总线请求
* CPU发总线响应信号，释放总线
* DMAC接管总线，控制外设、内存之间进行直接数据传送
* DMAC撤消总线请求
* CPU撤消总线响应，并重新接管总线

<img src="/assets/images/总线和接口.assets/image-20200317103527554.png" alt="image-20200317103527554" style="zoom:67%;" />

##### (5) DMAC的基本工作方式

* 单字节传输方式：DMA控制器每次请求总线只传送一个字节数据，传送完后即释放总线控制权

	* 假设从Memory → 外设

	<img src="/assets/images/总线和接口.assets/image-20200317103832918.png" alt="image-20200317103832918" style="zoom:50%;" />

* 块传输方式（也称组传输方式）：DMA控制器每次请求总线连续传送一个数据块，待整个数据块全部传送完成后再释放总线控制权

	<img src="/assets/images/总线和接口.assets/image-20200317103851721.png" alt="image-20200317103851721" style="zoom:50%;" />

* 请求传输方式：此方式与块传输方式基本类似，不同的是每传输完一个字节，DMA控制器都要检测由I/O接口发来的DMA请求信号是否仍然有效，如果该信号仍有效，则继续进行DMA传输；否则，就暂停传输，交还总线控制权给CPU，直至DMA请求信号再次变为有效，数据块传输则从刚才暂停的那一点继续

	* 随机请求

	<img src="/assets/images/总线和接口.assets/image-20200317103931548.png" alt="image-20200317103931548" style="zoom:50%;" />

##### (6) 示例：DMA输出一字节数据的过程

<img src="/assets/images/总线和接口.assets/image-20200317104026271.png" alt="image-20200317104026271" style="zoom:67%;" />

##### (7) DMA传送方式的特点

* 依靠硬件实现数据传送
	* 不运行程序，不能处理较复杂的事件。故DMA方式并不能完全取代中断方式，当某事件处理不只是单纯的数据传送时，还是需要采用中断方式。事实上，在以DMA方式传送完一批数据后，常利用中断通知通知CPU结束处理
* DMAC本身也是接口芯片
	* 在使用之前需要进行初始化配置
	* DMAC有个缺陷，无法对接口进行寻址，当多个外设需要采用DMA传送方式时，DMAC一般会设置多个通道，为多个外设提供DMA传送服务。每个通道都有自己的一套寄存器和DMA请求响应信号线。多个通道还需要通过优先级电路加以排队，决定先响应哪个通道的DMA请求

### (三) 并行接口

**串行和并行**

* 串行传输

	* 将需传输的比特串排成一行，一个接一个地在一条信道上传输
	* 串行总线只用一根信号线（如果传输的是差分信号则是两根信号线）来传输数据
	* 只需要少数几条线就可以在系统间交换信息，特别适用于计算机与计算机、计算机与外设之间的远距离通信

	<img src="/assets/images/总线和接口.assets/image-20200317104320408.png" alt="image-20200317104320408" style="zoom: 67%;" />

* 并行传输

	* 将数据以成组的方式在两条或更多的并列信道上进行传输
	* 一组数据的各数据位在多条线上同时传输
	* 并行通信时数据的各个比特位同时传送，可以字或字节为单位并行进行。并行通信速度快，但用到的信号线多、成本高，故不宜进行远距离通信

	<img src="/assets/images/总线和接口.assets/image-20200317104446777.png" alt="image-20200317104446777" style="zoom:67%;" />

#### 1、无握手信号的并行接口

##### (1) 无握手信号的并行接口典型电路

* 采用无握手信号接口连接的外设一般是功能简单的电路模块，如按键，数码显示管等。CPU与这些无握手信号的外设接口传输数据时，总是假定外设总是处于准备好的状态

<img src="/assets/images/总线和接口.assets/image-20200317104531592.png" alt="image-20200317104531592" style="zoom:50%;" />

##### (2) 输入接口示例：线性键盘

* 依据按键状态获取方式的不同，可以将键盘分为线性键盘和矩阵键盘，矩阵键盘又可分为非编码键盘和编码键盘
* 线性键盘的每一个按键需要占用I/O端口的一根口线
* 程序通过读取口线的电平状态来判断按键是否被按下。通常，程序需要实现按键状态的判断、按键的软件去抖动和按键状态的定义

<img src="/assets/images/总线和接口.assets/image-20200317104955441.png" alt="image-20200317104955441" style="zoom:50%;" />

##### (3) 输入接口示例：矩阵键盘

* 思路：首先输出0x00，读入如果为0xFF则无按键按下；再逐列检查是否有键按下，发现某列有键按下后再确定行

<img src="/assets/images/总线和接口.assets/image-20200317105044569.png" alt="image-20200317105044569" style="zoom: 67%;" />

<img src="/assets/images/总线和接口.assets/image-20200317105101666.png" alt="image-20200317105101666" style="zoom: 67%;" />

##### (4) 输出接口示例：LED显示

* 数码显示管是一种半导体发光器件，简称数码管。分为七段数码管和八段数码管，区别在于八段数码管比七段数码管多一个用于显示小数点的发光二极管单元DP（decimal point），其基本单元是发光二极管

<img src="/assets/images/总线和接口.assets/image-20200317105210646.png" alt="image-20200317105210646" style="zoom:50%;" />

**静态显示与动态显示**

* 实际系统中常需要多个数码管来同时显示多个数字，此时显示接口电路有静态显示和动态显示两种接口方式。静态显示方式就是，每个数码管相应的段（发光二极管）恒定地导通或截止，直到下一次更换信息
	* 若需要显示N个数字，那么数码管个数为N时，需要的接口口线数目为8×N
* 动态显示方式的基本思路是让各个数码管轮流显示，每位数码管的点亮时间约1～2ms，由于人的视觉暂留现象及发光二极管的余辉效应，尽管各个数码管并非同时点亮，但给人的印象是所有数码管同时显示
	* 在动态显示方式下，各个数码管的对应段输入控制端并连在一起，因此无论数码管的个数是多少，需要的口线数目都只需要8条，该端口称为段选口。各个数码管的公共端分别连接一根口线，该口线称为位选口。当数码管的个数为N时，则需要的位选口口线数目为N，因此动态显示方式总共需要的口线数为8＋N

**数码管的显示接口电路**

<img src="/assets/images/总线和接口.assets/image-20200317105335636.png" alt="image-20200317105335636" style="zoom: 67%;" />

* 图为显示5位十进制数的共阴极LED数码管接口电路。8位段选码由一个I/O端口控制，在每次输出段码之后，5个数码管同时获得了该段码值。要在每个数码管显示不同的字符，就必须采用扫描方法，轮流点亮各个LED数码管
* 扫描即控制位选码
* 显示第一个十进制数字时，段选控制端口输出相应字符的显示码；位选码中对应第一个数码管的位为“0”（低电平，因数码管为共阴极结构），而其他位为“1”（高电平）
* 显示第二个数字时，第二个数码管的位选码为“0”，其他位都为“1”

#### 2、带握手信号的并行接口

##### (1) 带握手信号的输入接口电路

<img src="/assets/images/总线和接口.assets/image-20200317105434284.png" alt="image-20200317105434284" style="zoom:67%;" />

* 输入设备发出选通信号，将准备好的数据送到接口电路的数据锁存器中，同时使D触发器置“1”并将该信号送到状态缓存寄存器中待CPU查询
* CPU读取接口中的状态寄存器，检查状态信息。READY为“1”，说明数据已到数据缓冲寄存器
* CPU读数据端口，同时数据端口的读信号将D触发器清零，令READY为“0”，完成本次传送

##### (2) 带握手信号的输出接口电路

<img src="/assets/images/总线和接口.assets/image-20200317105508707.png" alt="image-20200317105508707" style="zoom: 67%;" />

* CPU读状态寄存器，检查状态信息以确定外设是否可以接收数据
* 若BUSY为“0”，说明数据锁存器空，CPU向数据端口写入需发送的数据，同时数据端口的写信号将接口中的D触发器置“1”，即令BUSY为“1”，该信号通知输出设备数据已准备好，并送到状态寄存器
* 输出设备从接口的数据锁存器中读出数据
* 输出设备发出响应信号ACK将接口中的D触发器清零，即令BUSY为“0”，完成本次数据传送

#### 3、可编程并行接口（GPIO）

##### (1) 可编程并行接口（GPIO）模块电路

* 可编程通用并行接口是计算机及其他数字电路系统中最常使用的一种简单外部设备接口电路。其结构简单、应用途广泛，且可以通过编程控制字来实现控制，故得名“通用可编程I/O接口”，即GPIO（General-Purpose IO ports）

<img src="/assets/images/总线和接口.assets/image-20200317105616209.png" alt="image-20200317105616209" style="zoom: 67%;" />

##### (2) 可编程并行接口芯片8255

* 早期的计算机使用单独的可编程芯片来控制I/O，如英特尔的8255芯片有3个8位并行I/O口，具有3个通道、3种工作方式

	* 工作方式0：基本输入/输出方式
	* 工作方式1：选通输入/输出方式
	* 工作方式2：带选通的双向传送方式

	<img src="/assets/images/总线和接口.assets/image-20200317105739220.png" alt="image-20200317105739220" style="zoom: 67%;" />

##### (3) 典型嵌入式控制器的I/O端口位接口

* 微控制器芯片（单片机）往往会集成GPIO接口。一般来说，GPIO接口至少有两个寄存器，即“通用I/O控制寄存器”与“通用I/O数据寄存器”

<img src="/assets/images/总线和接口.assets/image-20200317105909799.png" alt="image-20200317105909799" style="zoom:67%;" />

### (四) 串行接口

#### 1、串行通信概述

##### (1) 概述

* 串行通信——数据在单条一位宽的传输信道上按时间先后一位一位地进行传送。与并行通信相比，串行通信具有以下特点：
	* 优点：
		* 不仅传输距离远，而且串行数据传送速率比并行数据传送速率更快，因为串行通信的通信时钟频率比并行通信更容易提高
		* 抗干扰能力强，通信费用低
		* 传输线既传数据，又传联络信息
	* 缺点：需要串/并转换，对数据格式有要求

##### (2) 通过Modem实现远程数据通信

串行通信常用于需要远距离传输的情形，然而受限于传输线的特性，数字信号无法在传输线上直接进行远距离传输。一般发送方需要使用调制器（Modulator），把要传送的数字信号调制为适合在线路上传输的信号；接收方则使用解调器（Demodulator），将从线路上接收到的调制信号进行解调，还原成数字信号。调制器和解调器两者通常集成在一起作为一个设备，称为调制解调器（Modem）

<img src="/assets/images/总线和接口.assets/image-20200317110205414.png" alt="image-20200317110205414" style="zoom: 67%;" />

调制解调器被称为DCE（Data Communication Equipment，数据通信设备）数据终端被称为DTE（Data Terminal Equipment，数据终端设备）

##### (3) 串行通信的性能参数

* 衡量数据传输速率有两个单位：
	* 比特率：单位时间内传送的二进制码元的个数，单位是bps ( bit per second )。由于1个二进制码元代表了1 bit的信息，因此比特率也称为传信率
	* 波特率：单位时间内传输的符号个数，单位是波特(Baud或Bd)
* 计算机普遍采用二进制，一个“符号”仅有高、低两种电平，分别代表逻辑值“1”和“0”，所以每个符号的信息量为1比特，此时波特率等于比特率。但在其它一些应用场合，一个“符号”的信息含量可能超过一个比特，此时波特率小于比特率

##### (4) 串行通信的同步方式

* 同步技术——能够检测和识别所传送的数据单元（位、字符或字节、帧、数据块等）的起止的技术
* 根据同步方式，串行通信又分为
	* 同步通信方式（Synchronous）
		* 收发双方在时钟同步的基础上，通过位同步以及帧同步等措施，保证可正确接收和识别所传送的数据
	* 异步通信方式（Asynchronous）
		* 收发双方通过信号波形编码表示所传输数据单元的起止。收发双方的时钟相位互不相关，甚至允许频率存在误差

##### (5) 同步通信方式

* 同步串行接口传输信息时，发送方和接收方电路在同一个时钟下工作，所传输信息的字节与字节之间、位与位之间均与时钟有严格的时间关系

	<img src="/assets/images/总线和接口.assets/image-20200317110446333.png" alt="image-20200317110446333" style="zoom:67%;" />

* 图中包含了八个数据位。很多同步协议首先发送MSB（Most Significant Bit），而很多异步协议首先发送LSB（Least Significant Bit）

##### (6) 异步通信方式

* 收发双方使用异步串行接口传输数据时，只使用数据线，而不像同步串行接口那样还需要时钟信号。异步串行接口常用于计算机系统之间的远程数据传输，可以实现远程通信

	<img src="/assets/images/总线和接口.assets/image-20200317110535622.png" alt="image-20200317110535622" style="zoom: 67%;" />

* 图示为异步传输协议下发送串行数据的示意，中包含了七个数据位、一个起始位和一个停止位

#### 2、异步串行概述

##### (1) 异步串行接口

* 如果采用相同的接口时钟频率，串行数据传输的速度要比并行传输慢得多，但对于覆盖面极其广阔的公用电话系统来说具有更大的现实意义
* 另外，并行接口时钟频率提升会遇到瓶颈，近年来出现了很多高速的串行接口标准
* “异步串行接口”包括了两方面的内容：
	* 串行通信双方进行数据传输时的接口电路
	* 收发双方约定的通信协议

##### (2) 异步串行数据帧格式

* 拟传输的数据以字符（一个字符通常含五至八位）为单位进行传送。考虑到传送发生的相对时间是随机的，为了确保整个通信过程的正确性，需要找一种合适的方法，使发送方和接收方在所传送的字符与字符间实现同步。常用的方法：在字符数据格式中设置起始位和停止位

	![image-20200317110702387](/assets/images/总线和接口.assets/image-20200317110702387.png)

* 一种可能的格式如图。每个字符传输包括：一个起始位（低电平，逻辑“0”）、五至八位有效数据位、一位奇偶校验位、一位（或1.5位，或2位）停止位，停止位（高电平）之后是不定长度的空闲位（高电平）

##### (3) 异步传输信号波形的检测

* 问题：难以保证收发双方时钟的频率完全相等、相位严格对齐 → 检测困难

* 解决办法：设约定的波特率为$N$，接收方用频率为$M$的时钟对接收信号进行检测，$M＝K×N$，$K$称为波特率因子，$K≥1$。有些芯片$K$可编程设置，有些固定，如$K=16$

	<img src="/assets/images/总线和接口.assets/image-20200317110826390.png" alt="image-20200317110826390" style="zoom: 67%;" />

* 假设$K=16$，接收端检测到一个低电平时，须证实是否的确是起始位。不同的芯片可能采用不同的方法，如：隔八个再检测一次，若仍为低电平则确认是起始位。或连续检测八个，若有五次以上是低电平则确认是起始位而不是干扰

* 确认了起始位后，从第九个检测脉冲（起始位中间位置）开始，接收端每隔16个脉冲采样一次输入信号，顺序接收各个数据位

##### (4) 异步串行接口电路

异步串行接口电路需要完成的基本功能包括：

* 数据的串/并、并/串转换
* 串行数据的格式化（如自动加入起始位、校验位或同步字符等）
* 校验码的生成
* 现接口间控制信号的解析
* 调制与解调

<img src="/assets/images/总线和接口.assets/image-20200317110952155.png" alt="image-20200317110952155" style="zoom: 67%;" />

* 发送过程：从数据总线上接收来自CPU的并行数据 → 基于移位寄存器进行并/串转换 → 入起始位、停止位等 → 按特定波特率由TXD发送
* 接收过程：RXD输入的数据 → 在本地时钟和波特率发生器的控制下，经同步控制器送给移位寄存器 → 串/并转换后进入接收缓存器 → 同时进行错误检测、帧解析并把相关信息写入状态寄存器 → 通过中断告知CPU接收完毕

##### (5) 异步串行接口信号定义

![image-20200317111134979](/assets/images/总线和接口.assets/image-20200317111134979.png)

##### (6) 异步串行接口协议

* 接口协议（标准）是通信的收发双方共同遵循的传输数据帧结构、传输速率、检错与纠错、数据控制信息类型等相关约定
* 在任何一个串行通信协议中，都会对接口物理层的机械特性、电气特性、规程特性和功能特性进行规范
* 本节讨论常见的异步串行通信协议，如RS-232、RS-422、RS423和RS-485

##### (7) 最常见的串行通信标准：RS-232C接口

* RS-232是由EIA（Electronic Industry Association，美国电子工业协会）1970年制定的串行二进制数据交换接口技术标准。先后出现了多个版本，其中应用最广的是修订版C，即RS-232C
* RS-232C标准最初是为远程通信连接数据终端设备（DTE）与数据通信设备（DCE）而制定的。虽然该标准并未考虑计算机系统的要求，但后来它被广泛应用于计算机系统
* RS-232C定义了DTE与DCE之间的物理接口标准。数据通信设备可以是传真机、电话机、智能终端等
	* 物理层中的连接指的是DTE和DCE之间的连接（又称接口）
	* 物理层的功能是在两个网络设备之间提供透明的比特流传输

**RS-232信号线定义——机械特性、功能特性**

<img src="/assets/images/总线和接口.assets/image-20200317112417753.png" alt="image-20200317112417753" style="zoom: 67%;" />

<img src="/assets/images/总线和接口.assets/image-20200317112437675.png" alt="image-20200317112437675" style="zoom:50%;" />

**标准串口的设置——规程特性**

* 波特率
* 数据位
* 奇偶校验位
* 停止位
* 流控制

**RS-232电气特性——负载电容与传输距离**

* RS-232C传输电缆的长度与负载的电容值有关
* 标准规定被驱动电路（终端）的电容，包括电缆的等效电容必须小于2500pF
* 对于多芯电缆，每英尺（0.305米）电容为40~50pF，所以满足电容特性要求的电缆长度最长为50英尺（约15米）

**RS-232电气特性——PC与一般单片机的串口逻辑电平**

* 电脑上的RS-232接口采用的是负逻辑电平
	* -15V~ -3V表示逻辑1
	* +15V~ +3V表示逻辑0
	* 电压值通常在7V左右
* 单片机的串口输出电路采用的逻辑电平是TTL电平。这种电平信号由TTL器件产生的，一般的芯片，如运放，数字器件等...
* TTL：Transistor-Transistor Logic 三极管结构
	* VCC：5V
	* VOH>=2.4V；VOL<=0.5V
	* VIH>=2V；VIL<=0.8V

##### (8) RS-422/432标准

* RS-232接口是一种基于单端非对称电路的接口，即一条信号线与一条地线，这种结构容易受到干扰，传输距离受限。为此，EIA又制定了RS-422和RS-423等标准
* RS-422标准采用了平衡差分传输技术，即每路信号都使用一对以地为参考的正负信号线。这种平衡差分结构的抗噪声能力较强，传输速率与距离都明显提高。最高传输速率为10Mbps，最远传输距离为4000英尺（1218米）
* RS422标准有点对点全双工与广播两种通信方式。广播方式下只允许一个发送驱动器工作，而接收器可以多达十个。RS-423则是RS-232与RS422之间的一个过渡标准，因而兼有两者的特点

##### (9) RS-485标准

* RS-485是RS-422标准的改进增强版本，该标准兼容了RS-422，提供了多点通信能力，很好地支持了联网功能，在仪器仪表和工业控制等领域得到了广泛的应用
* 多点通信能力的支持，把RS-232定义的异步串行接口改造为了一种总线。多个主机系统可以同时挂接到线缆上，RS-485实际上提供了“总线仲裁”的能力
* 在RS-485的多点通信系统中，接收器节点数可达32个，后期推出的版本则多达64/128/256个节点
* RS-485标准器件的数据传输速率有32Mbps、20Mhps、12Mbps、10Mbps、2.5Mbps及数百kbps等各种规格

##### (10)RS232/RS485/RS422特点对比

![image-20200317112939651](/assets/images/总线和接口.assets/image-20200317112939651.png)

####  3、I^2^C接口及总线

##### (1) NXP(Philips) Inter-Integrated Circuit (I^2^C)

* PHILIPS公司开发的两线式串行总线（一条串行数据线SDA，一条串行时钟线SCL），用于连接微控制器及其外围设备
	* Synchronous / Master-Slave Protocol / Half Duplex
* 标准模式下：100Kbps；快速模式下：400Kbps；高速模式下：3.4Mbps

<img src="/assets/images/总线和接口.assets/image-20200317113107037.png" alt="image-20200317113107037" style="zoom: 67%;" />

##### (2) 示例：2块芯片通过I^2^C连接

驱动SDA和SCL线的器件的输出级必须漏极开路（OD门），以实现总线的“线与”功能。使用外部上拉电阻（接电源），以确保当没有器件将线拉低时能保持高电平

<img src="/assets/images/总线和接口.assets/image-20200317113152483.png" alt="image-20200317113152483" style="zoom:50%;" />

##### (3) I^2^C接口典型电路

I^2^C的接口电路一般包括数据寄存器、控制寄存器、状态寄存器、地址寄存器，有些还包括和时钟有关的分频寄存器等

<img src="/assets/images/总线和接口.assets/image-20200317113228758.png" alt="image-20200317113228758" style="zoom: 67%;" />

##### (4) 主从式通信方式

* 为便于描述，I2C定义了“主器件”和“从器件”的概念。主器件（主机，或称为主设备）用于启动总线传送数据，并产生时钟，此时任何被寻址的器件均被认为是从器件（从机，或称为从设备）
* 从如果主器件要发送数据给从器件，则主器件首先寻址从器件，然后主动发送数据至从器件，最后由主器件终止数据传送
* 反之，如果主器件要接收从器件的数据，首先由主器件寻址从器件。然后主器件接收从器件发送的数据，最后由主器件终止接收过程

##### (5) 多主机总线

* I^2^C总线是一个多主机总线，在两根信号线上可同时挂接多个器件（存储器、键盘、LED、ADC等）。任何器件既可以作为主机也可以作为从机，但同一时刻只允许有一个主机
* I^2^C总线对发生在SDA信号线上的总线竞争进行仲裁。原理为：在检测到总线空闲（SCL和SDA均为高电平）后，拟使用总线的主机向SDA信号线发送数据（高电平或低电平），每一位数据发送后随即检测SDA信号线电平是否与自身发送电平一致，若电平不符则竞争失败，自动关闭其输出

##### (6) I^2^C的地址

* I^2^C总线采用两线制总线，不具备微机系统所具有的由多位地址线所组成的并行地址总线，那么地址如何实现？**串行发送地址**

	<img src="/assets/images/总线和接口.assets/image-20200317113858882.png" alt="image-20200317113858882" style="zoom:50%;" />

* 总线上每一个器件的地址必须是唯一的

* I^2^C标准中有7位地址和10位地址两种

##### (7) I^2^C总线协议状态

* 启动数据传输（S）停止数据传输（P）
* 重新启动（Sr）：重新启动可以让主器件在不失去总线控制的情况下改变总线方向
* 数据有效（D）应答（A）或不应答（N）
* 等待/ 数据无效（Q）总线空闲（I）

<img src="/assets/images/总线和接口.assets/image-20200317114018574.png" alt="image-20200317114018574" style="zoom: 67%;" />

##### (8) I^2^C数据传输过程

* 主设备向从设备发送信息
	* 主设备（master）发送开始信号(S)，对应图中(S)状态
	* 主设备发送7比特的从设备（slave）地址，对应图中发送地址阶段
	* 主设备发送写命令(低电平，W#)，对应图中R/W#
	* 接着从设备应答(A)，ACK为应答成功(A)，表示有这个设备
	* 主设备发送8位字节数据
	* 接着从设备应答，ACK为应答成功(A)，或，NACK为不成功为(N)
	* 如果从设备应答成功(A)继续主设备发送数据；若应答不成功(N)则主设备发送停止信号(P)，对应图中(P)状态

<img src="/assets/images/总线和接口.assets/image-20200317123703691.png" alt="image-20200317123703691" style="zoom:67%;" />

* 主设备读取从设备信息
	* 主设备发送开始信号(S)，对应图中(S)状态
	* 主设备发送7比特的从设备地址，对应图中发送地址阶段
	* 主设备发送读命令(高电平，R)，对应图中R/W#
	* 接着从设备应答(A)，ACK为应答成功(A)，表示有这个设备
	* 从设备发送8位字节数据，主设备从SDA上读取数据
	* 接着主设备应答，ACK为应答成功(A)，或，NACK为不成功为(N)
	* 如果主设备应答成功(A)则从设备继续往SDA上送数据；若应答不成功(N)则主设备在发送NACK后发送停止信号(P)，对应图中(P)状态

<img src="/assets/images/总线和接口.assets/image-20200317123759162.png" alt="image-20200317123759162" style="zoom:50%;" />

##### (9) I^2^C电气特性

* I^2^C允许不同制造工艺生产的器件、使用不同电源电压的器件进行通信。具有固定输入电平的I^2^C总线器件，可以分别单独连接适合自己的电源电压，但是SDA和SCL必须通过上拉电阻（图中RP）连接到5V的公共电源上。
* 单个IO引脚的负载电容不能超过10pF，所有IO引脚的总负载电容不能超过400pF。拓展传输距离和可挂接器件数目，可将I^2^C总线分段。分段时可以使用缓存（buffers）、多路复用器（multiplexers）、交换开关（switches）等不同的芯片隔离不同的段，每段总的负载电容不能超过400pF

<img src="/assets/images/总线和接口.assets/image-20200317123918497.png" alt="image-20200317123918497" style="zoom: 50%;" />

##### (10) I^2^C支持节点数

* 决定因素1：I^2^C从设备的地址位数。I^2^C标准中有7位地址和10位地址两种。如果是7位地址，允许挂接的I^2^C器件数量为：2^7^＝128，如果是10位地址，允许挂接的I^2^C器件数量为：2^10^＝1024，一般I^2^C总线上挂接的I2C器件不会太多，所以现在几乎所有的I^2^C器件都使用7位地址
* 决定因素2：挂在I^2^C总线上所有I^2^C器件的管脚寄生电容之和。I^2^C总线规范要求，I^2^C总线容性负载最大不能超过400pF

##### (11) I^2^C操作示例：读取串行EEPROM

* 所有报文都以“启动”条件开始并以“停止”条件终止
* 第一个字节是器件地址字节
* R/W = 0，表示主器件将充当发送器，从器件则将是接收器
* 接收到每个字节后，接收器件必须产生应答信号“ACK”
* ......
* 要让从器件向主器件发送数据，总线必须转为另一个方向。要实现此功能且不终止报文传送，主器件可发送一个“重新启动”信号。“重新启动”后接一个器件地址字节，该字节包含和前面相同的器件地址，但R/W = 1，以表明从器件发送，主器件接收
* 现在从器件发送驱动SDA 线的数据字节，主器件继续产生时钟信号

<img src="/assets/images/总线和接口.assets/image-20200317124202185.png" alt="image-20200317124202185" style="zoom:67%;" />

#### 4、SPI接口及总线

##### (1) SPI (Serial Peripheral Interface)

* 同步串行外设接口，它可以使MCU与各种外围设备以串行方式进行通信以交换信息。是Motorola首先在其MC68HCXX系列处理器上定义的。SPI接口主要应用在EEPROM，FLASH，实时时钟，AD转换器，还有数字信号处理器和数字信号解码器之间
* 需要至少4根线，事实上3根也可以（单向传输时）
	* MISO (Master Input Slave Output)，主设备数据输入，从设备数据输出
	* MOSI(Master Output Slave Input)，主设备数据输出，从设备数据输入
	* SCLK(Serial Clock)，时钟信号，由主设备产生
	* CS (Chip Select)，从设备使能信号，由主设备控制

##### (2) SPI中主设备与从设备的连接

* SPI上可以挂载一个主设备和多个从设备。任何时刻，一个主设备只与一个从设备进行通信，通信的从设备CS为低电平（有效）
* 在不使用CS信号时，SPI上只能有一个主设备与一个从设备
* SPI的缺点是没有应答机制，传输过程全都由主设备进行控制，数据传输成功与否没法直接验证

<img src="/assets/images/总线和接口.assets/image-20200317124510436.png" alt="image-20200317124510436" style="zoom:50%;" />

##### (3) SPI典型接口电路

* 发送缓冲区、移位寄存器、接收缓冲区的设计在一般串行通信接口电路中大体一致
* 状态寄存器SPI_SR、控制寄存器SPI_CR1、SPI_CR2、波特率控制寄存器BR虽然在不同厂家的SPI接口电路中也都有，但是寄存器比特定义往往略有差异

<img src="/assets/images/总线和接口.assets/image-20200317124554642.png" alt="image-20200317124554642" style="zoom:67%;" />

##### (3) SPI数据传输过程

* 通信过程由主设备（master）发起，从设备（slave）参与。当一个主设备需要向从设备发送数据，或者希望读取从设备数据的时候，主设备通过拉低对应从设备的CS#来告知从设备。对于主设备来说，发送数据就是把比特逐个放到MOSI信号线上，而读取数据就是在MISO信号线上进行采样

<img src="/assets/images/总线和接口.assets/image-20200317124630379.png" alt="image-20200317124630379" style="zoom:67%;" />

##### (4) SPI的四种工作模式

SPI工作状态简单，只有工作和空闲两个状态。根据空闲状态对应时钟的高电平还是低电平，以及时钟上升沿和下降沿的动作，可以形成不同四种工作方式

![image-20200317124706636](/assets/images/总线和接口.assets/image-20200317124706636.png)